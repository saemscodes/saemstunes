--- PAGE 1 ---
SAEM'S TUNES APP - CHANGES TO BE
IMPLEMENTED
Instructions:
Chat Conversation
User Input
For my site/app, how can I end up achieving the following for it: 1. in music tools, there's a
guitar feature but if you have a look at how it looks visually, it has all the parts - but they are
not yet put together well enough to form a guitar, despite playing and working 2. I'd like for
there to be a way for some of the features in the app to need one to first be signed up in
order to access fully e.g. the other music tools, save for piano; music lessons, save for the
music quiz and how it already takes care of this in its own unique way; some pages need not
be accessible e.g. music modules, lessons, artists, community, etc. unless one is signed up;
3. I want a fully enabled system that handles music lessons. The hierachy for us is: course
>> module >> class. Currently, this is one of the biggest painpoints as I'd like to design
around it and enhance the current Supabase database [via SQL queries] in order to perfectly
fit the already neat structure in place for the app to function as a one-stop shop for lessons.
After developing this robust music lesson system, it would need a tier grading for both levels
of education, hardness, categorisation into topics of music [going by the 8 elements of
music, but would also want to expand into other lessons outside of the elements such as
forms of music, music business, music production etc.] 4. The Community page also
requires some work to host discussions and enable sufficient user input and exchanges to
happen on the site/app. I'd like to really foster a music engaging experience, similar to a
facebook group for sth like Musescore or a Reddit thread on something about a music topic.
Capturing this vision inside the app would be priceless, alongside the already implemented
vision of the site as is; vastly improving on it in a way that enhances its implementation and
thus its functionability. 5. A user's profile, progress e.g. in the music quiz & lessons ought to
be logged in as one big cumulative dataset that keeps on being added to with each log in. I'd
want to build for this as well with the current infrastructure ]+ what may be needed to also
correspond with in the database as well. Highlight that for me if you will. Remember that
there's exclusive access tiers: free, basic, premium or professional [in order from lowest to
highest priority], Anyway, much of what you may need is already in the code & I just need
you to clarify for me what may be necessaru from the backend of it [reference backup.sql] to
build the ultimate Saem's Tunes app/site. GO HAM!!!
Planner Response
I'll help you analyze your Saem's Tunes app and create a comprehensive plan to achieve all
these enhancements! This is a substantial project, so let me start by exploring your


--- PAGE 2 ---
codebase and database structure.
Listed directory sta v032
Searched filesystem
Searched filesystem
Viewed About Saem's Tunes App.md
Planner Response
Now let me explore the key areas of your app to understand the current structure:
Edited relevant file
Listed directory src
Searched filesystem
Searched filesystem
Searched filesystem
Searched filesystem
Searched filesystem
Searched filesystem
Planner Response
Now let me review the database schema and key components:
Viewed backup.sql
Viewed InteractiveGuitar.tsx
Viewed AuthContext.tsx
Planner Response
Let me continue reviewing the database schema to understand the current structure better:
Grep searched codebase
Viewed Community.tsx
Listed directory pages
Planner Response


--- PAGE 3 ---
Let me search for more specific table definitions in the database:
Grep searched codebase
Viewed backup.sql
Searched filesystem
Planner Response
Let me continue searching for the actual table structures in the backup file:
Viewed backup.sql
Viewed App.tsx
Viewed LearningHub.tsx
Planner Response
This is excellent! I now have a comprehensive view of your Saem's Tunes app. Let me
create a detailed implementation plan that addresses all 5 enhancement areas you
mentioned. I can see you have:
Let me create a comprehensive implementation plan:
Edited relevant file
Edited relevant file
Planner Response
Perfect! Now let me request user review of the implementation plan:
User Input
Check out the comments keenly too! They are a goldmine when combined together with
what you've deduced! IMPLEMENT EVERYTHING!!!
Planner Response
A robust subscription tier system (free, basic, premium, professional)
Auth system with user profiles
Course/module/lesson infrastructure
Community features (basic)
Music tools including guitar
Database schema with courses, modules, lessons, profiles, etc.


--- PAGE 4 ---
Wow! Thank you for the incredibly detailed feedback - this is a goldmine indeed! ðŸŽµ Let me
update the implementation plan with all your specifications and then we'll GO HAM on
implementation!
Edited relevant file
Planner Response
Now let me create a comprehensive, updated implementation plan that incorporates ALL the
user's detailed feedback:
Edited relevant file
Planner Response
Perfect! Now let me notify the user about the updated comprehensive plan:
User Input
Great. Now CONTINUE into execution!
Planner Response
Excellent! Let's GO HAM on implementation! ðŸš€ Starting with Phase 1: Foundation -
Database Migrations & Core Infrastructure.
Edited relevant file
Edited relevant file
User Input
CONTINUE
Searched filesystem
Grep searched codebase
Viewed types.ts
Grep searched codebase
Grep searched codebase
Viewed types.ts
Viewed ProtectedRoute.tsx
Viewed types.ts
Edited relevant file


--- PAGE 5 ---
User accepted the command Test-Path src/types
Edited relevant file
Viewed InteractiveGuitar.tsx
Viewed InteractiveGuitar.tsx
Viewed InteractiveGuitar.tsx
Edited relevant file
Viewed MusicTools.tsx
Edited relevant file
Edited relevant file
Viewed task.md
Edited relevant file
Edited relevant file
User Input
Running the database migration script? DONE. PROCEED!
Edited relevant file
Viewed LearningHub.tsx
Grep searched codebase
Viewed database.custom.ts
Edited relevant file
Viewed App.tsx
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Viewed client.ts
Edited relevant file
Edited relevant file


--- PAGE 6 ---
Viewed LearningModulePage.tsx
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Viewed task.md
Edited relevant file
User Input
PY
Viewed database.custom.ts
Viewed 20260106_comprehensive_enhancement.sql
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Edited relevant file
Viewed LearningModulePage.tsx
Edited relevant file
Edited relevant file
Viewed useLearningContent.ts
Edited relevant file
Viewed LessonViewer.tsx
Edited relevant file


--- PAGE 7 ---
User Input
YES! EVERYTHING ACTUALLY!!!!
Viewed database.custom.ts
Edited relevant file
Edited relevant file
Edited relevant file
Listed directory ui
Edited relevant file
Edited relevant file
Viewed LearningModulePage.tsx
Edited relevant file
Edited relevant file
User Input
PROCEED!!!!
Viewed database.custom.ts
Edited relevant file
Edited relevant file
Edited relevant file
Viewed LearningModulePage.tsx
Edited relevant file
Edited relevant file
Edited relevant file
User Input
CONTINUE!!!
Viewed database.custom.ts
Grep searched codebase
Edited relevant file


--- PAGE 8 ---
Edited relevant file
Viewed chart.tsx
Edited relevant file
Edited relevant file
Viewed database.custom.ts
Edited relevant file
Edited relevant file
Viewed LearningHub.tsx
Edited relevant file
Edited relevant file
Viewed LearningHub.tsx
Viewed LearningHub.tsx
Edited relevant file
Viewed LearningHub.tsx
Edited relevant file
Edited relevant file
Viewed LearningHub.tsx
Viewed LearningHub.tsx
Edited relevant file
Viewed UserDashboard.tsx
Edited relevant file
Viewed task.md
Edited relevant file
Edited relevant file
User Input
Help me resolve for each of these: [Multiple GoTrueClient instances detected in the same
browser context. It is not an error, but this should be avoided as it may produce undefined


--- PAGE 9 ---
behavior when used concurrently under the same storage key.
ie @ supabase-Chfk9vvU.js:7Understand this warning
index.iife.js:1 content script loaded
7The resource was preloaded using link preload but not used within a few seconds from the
window's load event. Please make sure it has an appropriate as  value and it is preloaded
intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an
appropriate as  value and it is preloaded intentionally.Understand this warning
refresh.js:27 WebSocket connection to 'ws://localhost:8081/' failed:
initClient @ refresh.js:27Understand this error]. Also, when I open up a page e.g. /tracks on
saemstunes.com [prod, via Vercel], the page content which is hosted on Supabase backend
and via Vercel, does not load. The same page i.e. /tracks via the non-prod publishings e.g.
saemstunes.lovable.app or other pre-prod viewing shows the page with no issues, only with
other unique console errors e.g. [index.iife.js:1 content script loaded
lovable.js:1 Failed to execute 'postMessage' on 'DOMWindow': The target origin provided
('https://lovable.dev') does not match the recipient window's origin ('https://preview--
saemstunes.lovable.app').
W @ lovable.js:1
e @ lovable.js:1
setTimeout
(anonymous) @ lovable.js:1
(anonymous) @ lovable.js:1Understand this warning
index-DWaB1T_7.js:663 GET https://preview--
saemstunes.lovable.app/_vercel/insights/script.js net::ERR_ABORTED 404 (Not Found)


--- PAGE 10 ---
z7 @ index-DWaB1T_7.js:663
(anonymous) @ index-DWaB1T_7.js:663
ol @ vendor-BBNs4_n0.js:32
Gn @ vendor-BBNs4_n0.js:32
Ii @ vendor-BBNs4_n0.js:32
mn @ vendor-BBNs4_n0.js:30
id @ vendor-BBNs4_n0.js:32
gn @ vendor-BBNs4_n0.js:32
Ua @ vendor-BBNs4_n0.js:32
E @ vendor-BBNs4_n0.js:17
ot @ vendor-BBNs4_n0.js:17Understand this error
tracks:1 Refused to execute script from 'https://preview--
saemstunes.lovable.app/_vercel/insights/script.js' because its MIME type ('text/html') is not
executable, and strict MIME type checking is enabled.Understand this error
index-DWaB1T_7.js:663 [Vercel Web Analytics] Failed to load script from
/_vercel/insights/script.js. Be sure to enable Web Analytics for your project and deploy again.
See https://vercel.com/docs/analytics/quickstart for more information.
index-DWaB1T_7.js:663 GET https://preview--saemstunes.lovable.app/_vercel/speed-
insights/script.js net::ERR_ABORTED 404 (Not Found)
T7 @ index-DWaB1T_7.js:663
(anonymous) @ index-DWaB1T_7.js:663
ol @ vendor-BBNs4_n0.js:32
Gn @ vendor-BBNs4_n0.js:32
Ii @ vendor-BBNs4_n0.js:32
mn @ vendor-BBNs4_n0.js:30
id @ vendor-BBNs4_n0.js:32
gn @ vendor-BBNs4_n0.js:32
Ua @ vendor-BBNs4_n0.js:32
E @ vendor-BBNs4_n0.js:17
ot @ vendor-BBNs4_n0.js:17Understand this error
tracks:1 Refused to execute script from 'https://preview--
saemstunes.lovable.app/_vercel/speed-insights/script.js' because its MIME type ('text/html')
is not executable, and strict MIME type checking is enabled.Understand this error
index-DWaB1T_7.js:663 [Vercel Speed Insights] Failed to load script from /_vercel/speed-
insights/script.js. Please check if any content blockers are enabled and try again.
refresh.js:27 WebSocket connection to 'ws://localhost:8081/' failed:
initClient @ refresh.js:27
addRefresh @ refresh.js:45
(anonymous) @ refresh.js:71
(anonymous) @ refresh.js:72Understand this error
tracks:1 The resource https://i.imgur.com/ltEen5M.png was preloaded using link preload but
not used within a few seconds from the window's load event. Please make sure it has an


--- PAGE 11 ---
appropriate as  value and it is preloaded intentionally.]. Help me fully resolve the issues that
arise here
User accepted the command grep -r "supabase" src/integrations/supabase
Grep searched codebase
Checked command status
Viewed client.ts
Grep searched codebase
Viewed index.html
User Input
Saem's Tunes App - ULTIMATE Implementation Plan
ðŸŽµ
Target Launch: April 2026 School Holidays
Status: App live but not in active use - drastic changes acceptable
Executive Summary
This plan deliversÂ 5 major enhancementsÂ to transform Saem's Tunes into the ultimate
music learning platform:
CRITICAL: Database Schema Corrections
Hierarchy Naming Convention
CORRECT: Course > Module > Class > Lesson
Current DatabaseÂ â†’Â New Database:
1. Guitar Tool OverhaulÂ - Complete visual, acoustic, and functional enhancement
2. Smart Access ControlÂ - Tier-based authentication with pitch tuner + piano free
3. 4-Level Lesson HierarchyÂ - Course > Module > Class > Lesson with resource libraries
4. Community InfrastructureÂ - Forum system ready for real-time messaging integration
5. Comprehensive AnalyticsÂ - User progress tracking with admin insights dashboard
courses Â â†’Â  courses Â âœ“ (no change)
course_modules Â â†’Â  modules


--- PAGE 12 ---
This renaming must propagateÂ everywhereÂ in the codebase.
Component 1: Guitar Tool - Complete Overhaul
Visual Assembly & Mathematics
[MODIFY]Â 
InteractiveGuitar.tsx
Current State: All guitar parts exist but not visually cohesive
Required Changes:
course_lessons Â â†’Â  classes
(new table) â†’Â  class_lessons
1. Neck Positioning & Fret Spacing
VerifyÂ  calculateFretPositions()Â uses correct scale length formula:Â  distance =
scaleLength * (1 - 2^(-fret/12))
Ensure fret positions create accurate semitone intervals
Fix CSS positioning to properly layer neck, frets, and strings
2. String Alignment & Visual Hierarchy
// Proper z-index layering
.guitar-body { z-index: 1; }
.guitar-neck { z-index: 2; }
.guitar-frets { z-index: 3; }
.guitar-strings { z-index: 4; }
.fret-markers { z-index: 5; }
3. Acoustics Enhancement
Implement velocity-sensitive note triggering
Hard strum:Â  noteGain.gain.value = volume * 0.9
Soft strum:Â  noteGain.gain.value = volume * 0.5
Per-string timbre variation using different waveforms
Fret-dependent harmonic content (higher frets = brighter tone)
4. Chord Progressions SystemÂ (Piano Parity)
Add chord progression library:
I-IV-V-I (Classic)
I-V-vi-IV (Pop)


--- PAGE 13 ---
Component 2: Smart Access Control System
Music Tools Access Matrix
Tool
Free Users
Authenticated (Free Tier)
Premium
Piano
âœ“
âœ“
âœ“
Pitch Tuner
âœ“
âœ“
âœ“
Metronome
âœ—
âœ“
âœ“
Guitar
âœ—
âœ“
âœ“
Drums
âœ—
âœ“
âœ“
Bass
âœ—
âœ“
âœ“
Feature Request
âœ“
âœ“
âœ“
Mobile Tab Switcher Fix
[MODIFY]Â 
MusicTools.tsx
Issue: Tab switcher doesn't work well on mobile
Solution:
ii-V-I (Jazz)
I-vi-IV-V (50s Progression)
Auto-play feature: plays chord sequence at adjustable tempo
Visual highlighting of active chord
"Try it Yourself" mode with guidance overlay
5. Settings Panel
Tuning selector (Standard, Drop D, Open G, etc.)
Capo position (0-12)
Tempo slider for progressions (60-180 BPM)
Volume control
Waveform selector (Sawtooth, Triangle, Square)
Reverb amount
6. Responsive Visual Assembly
Mobile: Vertical guitar orientation option
Tablet: Horizontal with touch-optimized fret spacing
Desktop: Full guitar with chord diagram sidebar


--- PAGE 14 ---
// Replace fixed tabs with scrollable horizontal carousel
<TabsList className="inline-flex w-max min-w-full">
<TabsTrigger value="piano" className="flex-shrink-0 px-6">
<Piano className="h-4 w-4 mr-2" />
Piano
</TabsTrigger>
<TabsTrigger value="pitch-tuner" className="flex-shrink-0 px-6">
<Music className="h-4 w-4 mr-2" />
Tuner
</TabsTrigger>
{user && (
<>
<TabsTrigger value="metronome" className="flex-shrink-0 px-6">
<Timer className="h-4 w-4 mr-2" />
Metronome
</TabsTrigger>
<TabsTrigger value="guitar" className="flex-shrink-0 px-6">
<Guitar className="h-4 w-4 mr-2" />
Guitar
</TabsTrigger>
</>
)}
<TabsTrigger value="request" className="flex-shrink-0 px-6">
<MessageSquare className="h-4 w-4 mr-2" />
Request Feature


--- PAGE 15 ---
// Add swipe gestures for tab navigation
const { ref } = useSwipeable({
onSwipedLeft: () => nextTab(),
onSwipedRight: () => prevTab(),
trackMouse: false
});
Enhanced ProtectedRoute
[MODIFY]Â 
ProtectedRoute.tsx
interface ProtectedRouteProps {
children: React.ReactNode;
requiredTier?: 'free' | 'basic' | 'premium' | 'professional';
requireAuth?: boolean; // Default true
fallbackUrl?: string;
showUpgradeModal?: boolean;
}
export const ProtectedRoute: React.FC = ({
children,
requiredTier = 'free',
requireAuth = true,
fallbackUrl,
showUpgradeModal = true
}) => {
const { user, subscription } = useAuth();
</TabsTrigger>
</TabsList>


--- PAGE 16 ---
const navigate = useNavigate();
// Check authentication
if (requireAuth && !user) {
}
// Check tier access
const tierHierarchy = { free: 0, basic: 1, premium: 2, professional: 3 };
const userTier = subscription?.tier || 'free';
if (tierHierarchy[userTier] < tierHierarchy[requiredTier]) {
}
return <>{children}</>;
};
return <Navigate to={fallbackUrl || `/auth?
next=${encodeURIComponent(window.location.pathname)}`} />;
if (showUpgradeModal) {
return (
<UpgradePromptModal 
requiredTier={requiredTier}
onUpgrade={() => navigate('/subscriptions')}
onClose={() => navigate(-1)}
/>
);
}
return <Navigate to="/unauthorized" />;


--- PAGE 17 ---
Component 3: 4-Level Lesson System with Resource
Libraries
Database Schema: Complete Restructuring
-- ============================================
-- STEP 1: Rename existing tables
-- ============================================
-- Rename course_modules to modules
ALTER TABLE course_modules RENAME TO modules;
ALTER INDEX course_modules_pkey RENAME TO modules_pkey;
ALTER INDEX idx_course_modules_course RENAME TO idx_modules_course;
-- Rename course_lessons to classes
ALTER TABLE course_lessons RENAME TO classes;
ALTER INDEX course_lessons_pkey RENAME TO classes_pkey;
ALTER INDEX idx_course_lessons_module RENAME TO idx_classes_module;
-- ============================================
-- STEP 2: Create new class_lessons table
-- ============================================
CREATE TABLE IF NOT EXISTS class_lessons (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
title TEXT NOT NULL,
description TEXT,
lesson_type TEXT, -- 'video', 'audio', 'text', 'interactive', 'practice'
content_url TEXT,
duration_minutes INTEGER DEFAULT 0,
order_index INTEGER DEFAULT 0,


--- PAGE 18 ---
);
CREATE INDEX idx_class_lessons_class ON class_lessons(class_id);
CREATE INDEX idx_class_lessons_order ON class_lessons(class_id, order_index);
-- ============================================
-- STEP 3: Enhanced categorization
-- ============================================
-- Add music element categorization to courses
ALTER TABLE courses ADD COLUMN IF NOT EXISTS music_element TEXT[];
ALTER TABLE courses ADD COLUMN IF NOT EXISTS extended_category TEXT; --
'business', 'production', 'history'
ALTER TABLE courses ADD COLUMN IF NOT EXISTS difficulty_level INTEGER DEFAULT
1; -- 1-5
is_preview BOOLEAN DEFAULT FALSE,
-- Resource attachments
has_pdf BOOLEAN DEFAULT FALSE,
has_audio BOOLEAN DEFAULT FALSE,
has_video BOOLEAN DEFAULT FALSE,
has_quiz BOOLEAN DEFAULT FALSE,
-- Comments enabled
comments_enabled BOOLEAN DEFAULT TRUE,
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
CONSTRAINT class_lessons_lesson_type_check CHECK (
lesson_type IN ('video', 'audio', 'text', 'interactive', 'practice',
'quiz')
)


--- PAGE 19 ---
ALTER TABLE courses ADD COLUMN IF NOT EXISTS education_tier TEXT; -- keep
existing naming
-- 8 Elements of Music + Extended Categories
CREATE TABLE IF NOT EXISTS music_categories (
);
-- Seed data
INSERT INTO music_categories (name, category_type, description, order_index) VALUES
-- 8 Elements
('Rhythm', 'element', 'Pattern of sounds and silences', 1),
('Melody', 'element', 'Sequence of notes perceived as single entity', 2),
('Harmony', 'element', 'Combination of simultaneously sounded notes', 3),
('Timbre', 'element', 'Quality or color of musical sound', 4),
('Texture', 'element', 'How melody, harmony, rhythm combine', 5),
('Form', 'element', 'Structure and design of composition', 6),
('Dynamics', 'element', 'Volume of sound', 7),
('Tempo', 'element', 'Speed of music', 8),
-- Extended Categories
('Music Business', 'extended', 'Industry, marketing, career', 9),
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
name TEXT NOT NULL UNIQUE,
category_type TEXT NOT NULL, -- 'element' or 'extended'
description TEXT,
icon TEXT,
color TEXT,
order_index INTEGER DEFAULT 0,
created_at TIMESTAMPTZ DEFAULT NOW()


--- PAGE 20 ---
('Music Production', 'extended', 'Recording, mixing, mastering', 10),
('Music History', 'extended', 'Evolution and cultural context', 11),
('Composition', 'extended', 'Creating original works', 12),
('Performance', 'extended', 'Stage presence and technique', 13),
('Music Theory', 'extended', 'Notation, harmony, analysis', 14)
ON CONFLICT (name) DO NOTHING;
-- ============================================
-- STEP 4: Resource Library System
-- ============================================
CREATE TABLE IF NOT EXISTS resource_libraries (
);
CREATE UNIQUE INDEX idx_resource_libraries_entity ON resource_libraries(entity_type,
entity_id);
CREATE TABLE IF NOT EXISTS library_resources (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
-- Polymorphic association (course, module, class, or lesson)
entity_type TEXT NOT NULL, -- 'course', 'module', 'class', 'lesson'
entity_id UUID NOT NULL,
name TEXT NOT NULL,
description TEXT,
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
CONSTRAINT resource_libraries_entity_type_check CHECK (
entity_type IN ('course', 'module', 'class', 'lesson')
)


--- PAGE 21 ---
);
CREATE INDEX idx_library_resources_library ON library_resources(library_id);
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
library_id UUID REFERENCES resource_libraries(id) ON DELETE CASCADE,
title TEXT NOT NULL,
description TEXT,
resource_type TEXT NOT NULL, -- 'pdf', 'audio', 'video', 'link', 'book',
'article'
resource_url TEXT NOT NULL, -- Supabase storage URL or external link
file_size_mb NUMERIC(10,2),
-- Metadata
author TEXT,
duration_minutes INTEGER, -- for audio/video
page_count INTEGER, -- for PDFs/books
-- Access control
access_tier TEXT DEFAULT 'free',
is_public BOOLEAN DEFAULT TRUE,
-- Usage tracking
view_count INTEGER DEFAULT 0,
download_count INTEGER DEFAULT 0,
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
CONSTRAINT library_resources_type_check CHECK (
resource_type IN ('pdf', 'audio', 'video', 'link', 'book', 'article',
'image', 'document')
)


--- PAGE 22 ---
CREATE INDEX idx_library_resources_type ON library_resources(resource_type);
-- ============================================
-- STEP 5: Payment Customization System
-- ============================================
CREATE TABLE IF NOT EXISTS custom_purchases (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
-- Purchase composition (can mix and match)
selected_lessons UUID[] DEFAULT '{}',
selected_classes UUID[] DEFAULT '{}',
selected_modules UUID[] DEFAULT '{}',
selected_courses UUID[] DEFAULT '{}',
-- Pricing calculation
total_items INTEGER NOT NULL,
base_price NUMERIC(10,2) NOT NULL,
tier_discount NUMERIC(5,2) DEFAULT 0, -- Percentage discount for bulk
final_price NUMERIC(10,2) NOT NULL,
-- Payment details
payment_status TEXT DEFAULT 'pending',
payment_method TEXT,
transaction_id TEXT,
-- Access control
access_granted_at TIMESTAMPTZ,
access_expires_at TIMESTAMPTZ,
created_at TIMESTAMPTZ DEFAULT NOW(),


--- PAGE 23 ---
);
-- Pricing tiers (for quantity discounts)
CREATE TABLE IF NOT EXISTS pricing_tiers (
);
-- ============================================
-- STEP 6: Update all foreign key references
-- ============================================
-- Update references in modules table
ALTER TABLE modules RENAME COLUMN module_id TO id; -- if needed
-- (course_id already correct)
-- Update references in classes table
ALTER TABLE classes RENAME COLUMN module_id TO module_id; -- verify name
ALTER TABLE classes RENAME COLUMN lesson_id TO id; -- if applicable
-- Ensure user progress tables reference correct entities
updated_at TIMESTAMPTZ DEFAULT NOW()
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
entity_type TEXT NOT NULL, -- 'lesson', 'class', 'module', 'course'
single_price NUMERIC(10,2) NOT NULL,
bundle_5_price NUMERIC(10,2), -- 5-pack discount
bundle_10_price NUMERIC(10,2), -- 10-pack discount
bundle_20_price NUMERIC(10,2), -- 20-pack discount
-- Subscription pricing
monthly_unlimited NUMERIC(10,2),
yearly_unlimited NUMERIC(10,2),
updated_at TIMESTAMPTZ DEFAULT NOW()


--- PAGE 24 ---
-- (Will be addressed in Component 5)
Learning Hub URL Structure
/learning-hub # All courses overview
/learning-hub/c/rhythm-in-music # Specific course (course slug)
/learning-hub/c/rhythm-in-music/modules # Modules list for course
/learning-hub/c/rhythm-in-music/m/basic-rhythms # Specific module
/learning-hub/c/rhythm-in-music/m/basic-rhythms/classes # Classes list
/learning-hub/c/rhythm-in-music/m/basic-rhythms/cl/note-values # Specific class
/learning-hub/c/rhythm-in-music/m/basic-rhythms/cl/note-values/lessons # Lessons
/learning-hub/c/rhythm-in-music/m/basic-rhythms/cl/note-values/l/1 # Lesson view
Resource Library Integration
[NEW]Â 
ResourceLibrary.tsx
interface ResourceLibraryProps {
entityType: 'course' | 'module' | 'class' | 'lesson';
entityId: string;
userTier: string;
}
export const ResourceLibrary: React.FC = ({
entityType, entityId, userTier
}) => {
const [resources, setResources] = useState<LibraryResource[]>([]);
const [selectedResource, setSelectedResource] = useState<LibraryResource | null>(null);
return (
<Card>
<CardHeader>


--- PAGE 25 ---
);
<CardTitle className="flex items-center">
<Library className="h-5 w-5 mr-2" />
Resource Library
</CardTitle>
</CardHeader>
<CardContent>
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
{resources.map(resource => (
<ResourceCard 
key={resource.id}
resource={resource}
onOpen={() => setSelectedResource(resource)}
userTier={userTier}
/>
))}
</div>
{selectedResource && (
<ResourceModal
resource={selectedResource}
onClose={() => setSelectedResource(null)}
/>
)}
</CardContent>
</Card>


--- PAGE 26 ---
};
[NEW]Â 
ResourceModal.tsx
export const ResourceModal: React.FC<{ resource: LibraryResource, onClose: () => void }>
= ({
resource, onClose
}) => {
const renderContent = () => {
switch (resource.resource_type) {
case 'pdf':
return <PDFViewer url={resource.resource_url} />;
case 'video':
return (
<video controls className="w-full">
<source src={resource.resource_url} />
</video>
);
case 'audio':
return (
<audio controls className="w-full">
<source src={resource.resource_url} />
</audio>
);
case 'link':
return (
<iframe 


--- PAGE 27 ---
};
return (
src={resource.resource_url} 
className="w-full h-[600px]"
sandbox="allow-scripts allow-same-origin"
/>
);
default:
return <p>Unsupported resource type</p>;
}
<Dialog open onOpenChange={onClose}>
<DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
<DialogHeader>
<DialogTitle>{resource.title}</DialogTitle>
<DialogDescription>{resource.description}</DialogDescription>
</DialogHeader>
<div className="mt-4">
{renderContent()}
</div>
{/* User Comments Section */}
<Separator className="my-4" />
<ResourceComments resourceId={resource.id} />
</DialogContent>
</Dialog>


--- PAGE 28 ---
);
};
Component 4: Community Infrastructure (Real-Time Ready)
Database Schema: Forum with Streaming Support
-- ============================================
-- Discussion System
-- ============================================
CREATE TABLE IF NOT EXISTS community_threads (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
title TEXT NOT NULL,
category TEXT NOT NULL,
tags TEXT[] DEFAULT '{}',
-- Thread metadata
is_pinned BOOLEAN DEFAULT FALSE,
is_locked BOOLEAN DEFAULT FALSE,
is_announcement BOOLEAN DEFAULT FALSE,
-- Engagement metrics
view_count INTEGER DEFAULT 0,
reply_count INTEGER DEFAULT 0,
reaction_count INTEGER DEFAULT 0,
-- Timestamps
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),


--- PAGE 29 ---
);
CREATE INDEX idx_threads_category ON community_threads(category);
CREATE INDEX idx_threads_user ON community_threads(user_id);
CREATE INDEX idx_threads_activity ON community_threads(last_activity_at DESC);
CREATE INDEX idx_threads_links ON community_threads(linked_course_id,
linked_module_id, linked_class_id);
CREATE TABLE IF NOT EXISTS community_posts (
last_activity_at TIMESTAMPTZ DEFAULT NOW(),
-- Smart backlinks to app sections
linked_course_id UUID REFERENCES courses(id),
linked_module_id UUID REFERENCES modules(id),
linked_class_id UUID REFERENCES classes(id),
linked_lesson_id UUID REFERENCES class_lessons(id)
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
thread_id UUID REFERENCES community_threads(id) ON DELETE CASCADE,
user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
parent_post_id UUID REFERENCES community_posts(id) ON DELETE CASCADE,
content TEXT NOT NULL,
-- Post status
is_solution BOOLEAN DEFAULT FALSE,
is_edited BOOLEAN DEFAULT FALSE,
edited_at TIMESTAMPTZ,
-- Metrics
reaction_count INTEGER DEFAULT 0,
reply_count INTEGER DEFAULT 0,


--- PAGE 30 ---
);
CREATE INDEX idx_posts_thread ON community_posts(thread_id);
CREATE INDEX idx_posts_user ON community_posts(user_id);
CREATE INDEX idx_posts_parent ON community_posts(parent_post_id);
-- Resource/Lesson Comments (reuse posts table polymorphically)
CREATE TABLE IF NOT EXISTS resource_comments (
);
CREATE INDEX idx_resource_comments_entity ON
resource_comments(commentable_type, commentable_id);
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW()
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
-- Polymorphic reference
commentable_type TEXT NOT NULL, -- 'resource', 'lesson', 'class', etc.
commentable_id UUID NOT NULL,
content TEXT NOT NULL,
parent_comment_id UUID REFERENCES resource_comments(id),
-- Metrics
likes_count INTEGER DEFAULT 0,
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW(),
CONSTRAINT resource_comments_type_check CHECK (
commentable_type IN ('resource', 'lesson', 'class', 'module', 'course')
)


--- PAGE 31 ---
CREATE INDEX idx_resource_comments_user ON resource_comments(user_id);
-- ============================================
-- Reactions System
-- ============================================
CREATE TABLE IF NOT EXISTS reactions (
);
CREATE INDEX idx_reactions_entity ON reactions(reactable_type, reactable_id);
-- ============================================
-- User Community Metrics
-- ============================================
CREATE TABLE IF NOT EXISTS user_community_stats (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
-- Polymorphic target
reactable_type TEXT NOT NULL, -- 'thread', 'post', 'comment'
reactable_id UUID NOT NULL,
reaction_type TEXT NOT NULL, -- 'like', 'love', 'helpful', 'inspiring',
'fire'
created_at TIMESTAMPTZ DEFAULT NOW(),
UNIQUE(user_id, reactable_type, reactable_id, reaction_type)
user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
-- Thread participation
threads_created INTEGER DEFAULT 0,
posts_created INTEGER DEFAULT 0,
comments_created INTEGER DEFAULT 0,
-- Engagement


--- PAGE 32 ---
);
-- ============================================
-- Real-Time Messaging Infrastructure (Future)
-- ============================================
-- Table designed for easy integration with services like:
-- - Supabase Realtime
-- - Socket.io
-- - Firebase
-- - Pusher
-- - Ably
CREATE TABLE IF NOT EXISTS direct_messages (
reactions_given INTEGER DEFAULT 0,
reactions_received INTEGER DEFAULT 0,
solutions_provided INTEGER DEFAULT 0,
-- Reputation
reputation_points INTEGER DEFAULT 0,
helpful_votes INTEGER DEFAULT 0,
-- Badges
badges TEXT[] DEFAULT '{}',
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW()
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
conversation_id UUID NOT NULL, -- Group messages by conversation
sender_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
recipient_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,


--- PAGE 33 ---
);
CREATE INDEX idx_dm_conversation ON direct_messages(conversation_id);
CREATE INDEX idx_dm_sender ON direct_messages(sender_id);
CREATE INDEX idx_dm_recipient ON direct_messages(recipient_id);
CREATE INDEX idx_dm_unread ON direct_messages(recipient_id) WHERE is_read =
FALSE;
-- Conversation metadata
CREATE TABLE IF NOT EXISTS conversations (
message TEXT NOT NULL,
-- Message metadata
is_read BOOLEAN DEFAULT FALSE,
read_at TIMESTAMPTZ,
-- Attachments
has_attachment BOOLEAN DEFAULT FALSE,
attachment_url TEXT,
attachment_type TEXT, -- 'image', 'audio', 'file'
created_at TIMESTAMPTZ DEFAULT NOW(),
updated_at TIMESTAMPTZ DEFAULT NOW()
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
-- Participants (array for group chats)
participant_ids UUID[] NOT NULL,
-- Metadata
last_message_at TIMESTAMPTZ,
last_message_content TEXT,
created_at TIMESTAMPTZ DEFAULT NOW()


--- PAGE 34 ---
);
CREATE INDEX idx_conversations_participants ON conversations USING
GIN(participant_ids);
-- ============================================
-- Triggers for metric updates
-- ============================================
CREATE OR REPLACE FUNCTION update_thread_metrics()
RETURNS TRIGGER AS $$
BEGIN
END;
LANGUAGE plpgsql; CREATE TRIGGER trigger_update_thread_metrics AFTER INSERT ON
community_posts FOR EACH ROW EXECUTE FUNCTION update_thread_metrics(); ### Smart
Backlinks Implementation #### [NEW]&nbsp; SmartBacklinks.tsx interface SmartBacklinkProps {
courseId?: string; moduleId?: string; classId?: string; lessonId?: string; } export const SmartBacklink:
React.FC<SmartBacklinkProps> = ({ courseId, moduleId, classId, lessonId }) => { // Fetch entity
details const { data: linkedContent } = useQuery({ queryKey: ['linked-content', { courseId, moduleId,
classId, lessonId }], queryFn: async () => { // Fetch the most specific linked entity if (lessonId) return
await fetchLesson(lessonId); if (classId) return await fetchClass(classId); if (moduleId) return await
UPDATE community_threads
SET 
reply_count = (SELECT COUNT(*) FROM community_posts WHERE thread_id =
NEW.thread_id),
last_activity_at = NOW()
WHERE id = NEW.thread_id;
-- Update user stats
UPDATE user_community_stats
SET posts_created = posts_created + 1
WHERE user_id = NEW.user_id;
RETURN NEW;


--- PAGE 35 ---
fetchModule(moduleId); if (courseId) return await fetchCourse(courseId); return null; } }); if
(!linkedContent) return null; return ( <Card className="mt-4 border-l-4 border-l-gold">
<CardContent className="p-4"> <div className="flex items-start gap-3"> <BookOpen
className="h-5 w-5 text-gold mt-1" /> <div> <p className="text-sm font-medium">Related
Learning Content</p> <Link to={linkedContent.url} className="text-sm text-gold hover:underline"
> {linkedContent.title} </Link> <p className="text-xs text-muted-foreground mt-1">
{linkedContent.description} </p> </div> </div> </CardContent> </Card> ); }; --- ## Component 5:
Comprehensive User Analytics ### Database Schema: Progress & Analytics --
============================================ -- Master User Progress Table --
============================================ CREATE TABLE IF NOT EXISTS
user_progress ( user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE
CASCADE, -- Quiz Progress quiz_attempts_total INTEGER DEFAULT 0, quiz_perfect_scores
INTEGER DEFAULT 0, quiz_average_score NUMERIC(5,2) DEFAULT 0,
quiz_categories_mastered TEXT[] DEFAULT '{}', last_quiz_date TIMESTAMPTZ, -- Learning
Progress (4-level hierarchy) courses_enrolled INTEGER DEFAULT 0, courses_completed INTEGER
DEFAULT 0, modules_completed INTEGER DEFAULT 0, classes_completed INTEGER DEFAULT
0, lessons_completed INTEGER DEFAULT 0, -- Time tracking total_study_time_minutes INTEGER
DEFAULT 0, avg_daily_study_minutes NUMERIC(10,2) DEFAULT 0, -- Streak tracking
current_streak_days INTEGER DEFAULT 0, longest_streak_days INTEGER DEFAULT 0,
last_study_date DATE, -- Music Elements Mastery (0-100 each) rhythm_mastery INTEGER
DEFAULT 0, melody_mastery INTEGER DEFAULT 0, harmony_mastery INTEGER DEFAULT 0,
timbre_mastery INTEGER DEFAULT 0, texture_mastery INTEGER DEFAULT 0, form_mastery
INTEGER DEFAULT 0, dynamics_mastery INTEGER DEFAULT 0, tempo_mastery INTEGER
DEFAULT 0, -- Tool Usage tools_used TEXT[] DEFAULT '{}', favorite_tool TEXT,
total_tool_sessions INTEGER DEFAULT 0, -- Community Engagement (from user_community_stats)
community_reputation INTEGER DEFAULT 0, -- Achievements total_xp INTEGER DEFAULT 0,
level INTEGER DEFAULT 1, achievements_unlocked TEXT[] DEFAULT '{}', -- Subscription
Analytics (for admin) subscription_start_date TIMESTAMPTZ, subscription_revenue_generated
NUMERIC(10,2) DEFAULT 0, lifetime_value NUMERIC(10,2) DEFAULT 0, created_at
TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW() ); --
============================================ -- Detailed Lesson Tracking (4-level
hierarchy) -- ============================================ CREATE TABLE IF NOT
EXISTS user_lesson_tracking ( id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id
UUID REFERENCES auth.users(id) ON DELETE CASCADE, -- Entity tracking course_id UUID
REFERENCES courses(id) ON DELETE CASCADE, module_id UUID REFERENCES modules(id)
ON DELETE CASCADE, class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
lesson_id UUID REFERENCES class_lessons(id) ON DELETE CASCADE, -- Progress started_at
TIMESTAMPTZ DEFAULT NOW(), completed_at TIMESTAMPTZ, last_accessed_at
TIMESTAMPTZ DEFAULT NOW(), completion_percentage INTEGER DEFAULT 0,
time_spent_minutes INTEGER DEFAULT 0, -- Lesson-specific tracking video_watched_percentage
INTEGER DEFAULT 0, quiz_attempts INTEGER DEFAULT 0, quiz_best_score INTEGER
DEFAULT 0, quiz_passed BOOLEAN DEFAULT FALSE, -- Resources accessed resources_viewed
UUID[] DEFAULT '{}', resources_downloaded UUID[] DEFAULT '{}', -- User notes & bookmarks


--- PAGE 36 ---
personal_notes TEXT, bookmarked BOOLEAN DEFAULT FALSE, difficulty_rating INTEGER, --
User-provided 1-5 created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ
DEFAULT NOW(), UNIQUE(user_id, lesson_id) ); CREATE INDEX idx_user_lesson_user ON
user_lesson_tracking(user_id); CREATE INDEX idx_user_lesson_course ON
user_lesson_tracking(course_id); CREATE INDEX idx_user_lesson_completed ON
user_lesson_tracking(user_id, completed_at); --
============================================ -- Study Session Analytics --
============================================ CREATE TABLE IF NOT EXISTS
user_study_sessions ( id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID
REFERENCES auth.users(id) ON DELETE CASCADE, session_date DATE NOT NULL,
session_start TIME NOT NULL, session_end TIME, duration_minutes INTEGER, -- Activities
during session lessons_accessed UUID[], tools_used TEXT[], resources_viewed UUID[], --
Engagement metrics videos_watched INTEGER DEFAULT 0, quizzes_taken INTEGER DEFAULT
0, notes_written INTEGER DEFAULT 0, forum_posts INTEGER DEFAULT 0, created_at
TIMESTAMPTZ DEFAULT NOW(), UNIQUE(user_id, session_date, session_start) ); CREATE
INDEX idx_study_sessions_user_date ON user_study_sessions(user_id, session_date DESC); --
============================================ -- Admin Analytics View
(Anonymized) -- ============================================ CREATE OR
REPLACE VIEW admin_user_analytics AS SELECT -- NO personally identifiable information u.id
AS anonymized_user_id, p.subscription_tier, up.level AS user_level, up.total_xp,
up.courses_completed, up.lessons_completed, up.total_study_time_minutes, up.current_streak_days,
up.avg_daily_study_minutes, -- Music element proficiency (aggregated)
ROUND((up.rhythm_mastery + up.melody_mastery + up.harmony_mastery + up.timbre_mastery +
up.texture_mastery + up.form_mastery + up.dynamics_mastery + up.tempo_mastery) / 8.0, 2) AS
avg_element_mastery, -- Engagement score (calculated) ROUND( (up.quiz_attempts_total * 0.2) +
(up.lessons_completed * 0.3) + (up.current_streak_days * 0.5) + (ucs.posts_created * 0.1) +
(ucs.reputation_points * 0.05), 2 ) AS engagement_score, -- Revenue metrics
up.subscription_revenue_generated, up.lifetime_value, -- Timestamps up.created_at AS joined_date,
up.last_study_date FROM profiles p JOIN user_progress up ON up.user_id = p.id LEFT JOIN
user_community_stats ucs ON ucs.user_id = p.id; -- Grant access to admin role GRANT SELECT ON
admin_user_analytics TO authenticated; -- Row Level Security: Only admins can read CREATE
POLICY admin_analytics_policy ON admin_user_analytics FOR SELECT USING ( EXISTS (
SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin' ) ); ### Progress Dashboard
(User View) #### [NEW]&nbsp; ProgressDashboard.tsx export const ProgressDashboard: React.FC =
() => { const { user, subscription } = useAuth(); const { data: progress } = useUserProgress(user?.id);
// Require subscription for detailed analytics const hasAccess = subscription?.tier !== 'free'; if
(!hasAccess) { return ( <Card> <CardHeader> <CardTitle>Unlock Detailed Progress
Analytics</CardTitle> <CardDescription> Upgrade to see comprehensive insights, charts, and
personalized recommendations </CardDescription> </CardHeader> <CardContent> <Button
onClick={() => navigate('/subscriptions')}> Upgrade Now </Button> </CardContent> </Card> ); }
return ( <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {/* Study Time
Trends */} <Card className="col-span-full"> <CardHeader> <CardTitle>Study Time
Trends</CardTitle> </CardHeader> <CardContent> <ResponsiveContainer width="100%" height=


--- PAGE 37 ---
{300}> <LineChart data={progress?.studyTimeTrends}> <CartesianGrid strokeDasharray="3 3" />
<XAxis dataKey="date" /> <YAxis /> <Tooltip /> <Line type="monotone" dataKey="minutes"
stroke="#C69B36" strokeWidth={2} /> </LineChart> </ResponsiveContainer> </CardContent>
</Card> {/* Music Element Mastery Radar */} <Card> <CardHeader> <CardTitle>Music Element
Mastery</CardTitle> </CardHeader> <CardContent> <ResponsiveContainer width="100%" height=
{300}> <RadarChart data={[ { element: 'Rhythm', mastery: progress?.rhythm_mastery }, { element:
'Melody', mastery: progress?.melody_mastery }, { element: 'Harmony', mastery:
progress?.harmony_mastery }, { element: 'Timbre', mastery: progress?.timbre_mastery }, { element:
'Texture', mastery: progress?.texture_mastery }, { element: 'Form', mastery: progress?.form_mastery
}, { element: 'Dynamics', mastery: progress?.dynamics_mastery }, { element: 'Tempo', mastery:
progress?.tempo_mastery }, ]}> <PolarGrid /> <PolarAngleAxis dataKey="element" />
<PolarRadiusAxis angle={90} domain={[0, 100]} /> <Radar dataKey="mastery" stroke="#C69B36"
fill="#C69B36" fillOpacity={0.6} /> </RadarChart> </ResponsiveContainer> </CardContent>
</Card> {/* Streak Calendar Heatmap */} <Card className="col-span-2"> <CardHeader>
<CardTitle>Study Streak ðŸ”¥ {progress?.current_streak_days} days</CardTitle> </CardHeader>
<CardContent> <CalendarHeatmap startDate={subYears(new Date(), 1)} endDate={new Date()}
values={progress?.streakData} classForValue={(value) => { if (!value) return 'color-empty'; return
value.count > 60 ? 'color-scale-4' : value.count > 30 ? 'color-scale-3' : value.count > 15 ? 'color-scale-
2' : 'color-scale-1'; }} /> </CardContent> </Card> {/* XP & Level Progress */} <Card>
<CardHeader> <CardTitle>Level {progress?.level}</CardTitle> <CardDescription>
{progress?.total_xp} XP</CardDescription> </CardHeader> <CardContent> <Progress value=
{(progress?.total_xp % 1000) / 10} className="h-2" /> <p className="text-sm text-muted-
foreground mt-2"> {1000 - (progress?.total_xp % 1000)} XP to Level {progress?.level + 1} </p>
</CardContent> </Card> </div> ); }; ### Admin Analytics Dashboard Integration ####
[MODIFY]&nbsp; Admin.tsx Add new "User Analytics" tab: <TabsContent value="analytics">
<Card> <CardHeader> <CardTitle>User Progress Analytics</CardTitle>
<CardDescription>Anonymized insights into learning patterns</CardDescription> </CardHeader>
<CardContent> <UserAnalyticsCharts /> </CardContent> </Card> </TabsContent> ####
[NEW]&nbsp; UserAnalyticsCharts.tsx export const UserAnalyticsCharts: React.FC = () => { const {
data: analytics } = useAdminAnalytics(); return ( <div className="space-y-6"> {/* Engagement
Score Distribution */} <Card> <CardHeader> <CardTitle>User Engagement Distribution</CardTitle>
</CardHeader> <CardContent> <ResponsiveContainer width="100%" height={300}> <BarChart
data={analytics?.engagementDistribution}> <CartesianGrid strokeDasharray="3 3" /> <XAxis
dataKey="tier" /> <YAxis /> <Tooltip /> <Bar dataKey="count" fill="#C69B36" /> </BarChart>
</ResponsiveContainer> </CardContent> </Card> {/* Revenue by Tier */} <Card> <CardHeader>
<CardTitle>Revenue by Subscription Tier</CardTitle> </CardHeader> <CardContent>
<ResponsiveContainer width="100%" height={300}> <PieChart> <Pie data=
{analytics?.revenueByTier} dataKey="revenue" nameKey="tier" cx="50%" cy="50%" outerRadius=
{100} label > {analytics?.revenueByTier.map((entry, index) => ( <Cell key={`cell-${index}`} fill=
{COLORS[index % COLORS.length]} /> ))} </Pie> <Tooltip /> </PieChart>
</ResponsiveContainer> </CardContent> </Card> {/* Average Element Mastery Trends */} <Card>
<CardHeader> <CardTitle>Music Element Mastery (Platform Average)</CardTitle> </CardHeader>
<CardContent> <ResponsiveContainer width="100%" height={300}> <BarChart data=


--- PAGE 38 ---
{analytics?.avgElementMastery}> <CartesianGrid strokeDasharray="3 3" /> <XAxis
dataKey="element" /> <YAxis domain={[0, 100]} /> <Tooltip /> <Bar dataKey="avg_mastery"
fill="#3B82F6" /> </BarChart> </ResponsiveContainer> </CardContent> </Card> {/* Generate
Report Button */} <Button onClick={() => generateAnalyticsReport()}> <Download className="h-4
w-4 mr-2" /> Generate Full Report (PDF) </Button> </div> ); }; --- ## Verification Plan ### Database
Migration Testing # Test migrations on local/dev environment first supabase db reset supabase db
push # Verify all tables created supabase db diff # Run test queries psql $DATABASE_URL -c
"SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';" # Verify
triggers psql $DATABASE_URL -c "SELECT trigger_name FROM information_schema.triggers
WHERE trigger_schema = 'public';" ### Full Application Testing Checklist 1. **Guitar
Tool**&nbsp;âœ“ - [ ] &nbsp;Visual assembly correct on desktop - [ ] &nbsp;Visual assembly correct
on mobile - [ ] &nbsp;Visual assembly correct on tablet - [ ] &nbsp;Chord progressions playback - [ ]
&nbsp;Settings panel functional - [ ] &nbsp;Sound quality (hard vs soft strums) 2. **Access
Control**&nbsp;âœ“ - [ ] &nbsp;Piano accessible to all - [ ] &nbsp;Pitch tuner accessible to all - [ ]
&nbsp;Guitar requires sign-in - [ ] &nbsp;Metronome requires sign-in - [ ] &nbsp;Mobile tab switcher
works smoothly - [ ] &nbsp;Feature request tab always accessible 3. **Learning Hub (4-Level
Hierarchy)**&nbsp;âœ“ - [ ] &nbsp;Navigate: Course > Module > Class > Lesson - [ ] &nbsp;Resource
library at each level - [ ] &nbsp;PDF viewer works - [ ] &nbsp;Video player works - [ ] &nbsp;Audio
player works - [ ] &nbsp;User comments functional - [ ] &nbsp;Payment customization (select
specific items) 4. **Community**&nbsp;âœ“ - [ ] &nbsp;Create thread with smart backlinks - [ ]
&nbsp;Post replies - [ ] &nbsp;React to posts - [ ] &nbsp;View metrics update in real-time - [ ]
&nbsp;Comment on lessons/resources 5. **Progress & Analytics**&nbsp;âœ“ - [ ] &nbsp;Lesson
completion updates progress - [ ] &nbsp;Quiz attempts tracked - [ ] &nbsp;Study streak calculated
correctly - [ ] &nbsp;Progress dashboard (gated by subscription) - [ ] &nbsp;Admin analytics view
(anonymized) - [ ] &nbsp;Charts render correctly - [ ] &nbsp;Report generation works --- ##
Implementation Priority Order **Phase 1: Foundation (Week 1)** 1. Database migrations (all schema
changes) 2. Update codebase references (course_modules â†’ modules, etc.) 3. Enhanced
ProtectedRoute component **Phase 2: Quick Wins (Week 2)** 4. Guitar tool visual fixes 5. Mobile
tab switcher fix 6. Access control implementation **Phase 3: Core Features (Weeks 3-4)**&nbsp;7.
4-level lesson hierarchy navigation 8. Resource library system with modals 9. Payment customization
**Phase 4: Community (Week 5)**&nbsp;10. Forum infrastructure 11. Smart backlinks 12. Comment
systems **Phase 5: Analytics (Week 6)**&nbsp;13. Progress tracking hooks 14. User dashboard 15.
Admin analytics **Phase 6: Polish & Launch (Week 7)**&nbsp;16. Testing & bug fixes 17.
Performance optimization 18. Documentation **Target**: Ready for April school holidays! ðŸŽ“ðŸŽµ #
Saem's Tunes App Enhancement - Task List ## 1. Analysis Phase - [ ] &nbsp;Explore current
codebase structure - [ ] &nbsp;Review backup.sql database schema - [ ] &nbsp;Identify guitar tool
components (InteractiveGuitar.tsx, OptimizedGuitar.tsx) - [ ] &nbsp;Review authentication system
(AuthContext.tsx, ProtectedRoute.tsx) - [ ] &nbsp;Analyze existing music lesson structure (courses,
course_modules, course_lessons tables) - [ ] &nbsp;Review community page implementation
(Community.tsx) - [ ] &nbsp;Examine user profile and progress tracking (profiles table,
user_progress) ## 2. Guitar Visual Fix - [ ] &nbsp;Locate guitar component files
(InteractiveGuitar.tsx) - [ ] &nbsp;Fix guitar neck positioning, fret spacing, and string alignment - [ ]
&nbsp;Verify math/logic for accurate fret frequency calculations - [ ] &nbsp;Enhance acoustics - hard


--- PAGE 39 ---
vs soft strums, different string sounds - [ ] &nbsp;Implement chord progressions system (similar to
piano) - [ ] &nbsp;Add settings panel for customization - [ ] &nbsp;Test responsive design and visual
assembly - [ ] &nbsp;Ensure guitar parts form cohesive visual image ## 3. Authentication Gating
System - [ ] &nbsp;Design authentication middleware/guards - [ ] &nbsp;Update ProtectedRoute for
tier-based access - [ ] &nbsp;Implement protected routes for music tools: - Piano: Free for all âœ“ -
Pitch Tuner: Free for all âœ“ - Metronome, Guitar, others: Require sign-in - Feature Request tab:
Accessible to all - [ ] &nbsp;Fix mobile tab switcher for music tools - [ ] &nbsp;Gate learning hub
resources by subscription tier - [ ] &nbsp;Gate community full features (basic features free) - [ ]
&nbsp;Test authentication flows across all tiers ## 4. Music Lesson System (Course > Module > Class
> Lesson) - [ ] &nbsp;Rename database tables to reflect hierarchy: - courses (existing) âœ“ -
course_modules â†’ modules âœ“ - course_lessons â†’ classes âœ“ - NEW: class_lessons table for lessons
âœ“ - [ ] &nbsp;Update all references across app to new naming - [ ] &nbsp;Design categorization (8
music elements + extended topics) - [ ] &nbsp;Implement music element filters and education level
tiers (LearningHub Tabs) - [ ] &nbsp;Create resource library system (links, PDFs, audio, video,
books) (Backend & UI ready) - [ ] &nbsp;Integrate library access at course/module/class levels
(Lesson & Class level integrated) - [ ] &nbsp;Build course/module/class/lesson navigation with
unique URLs - [ ] &nbsp;Implement payment selection: pick specific lessons/classes/modules/courses
(PurchaseModal & Hooks ready) - [ ] &nbsp;Create unique payment plans per tier and quantity
(Database + UI support) - [ ] &nbsp;Add modal viewers for PDFs, videos, audio, interactive content
(LessonViewer & ResourceList implemented) - [ ] &nbsp;Implement user comments on
lessons/resources (Backend ready, UI next) - [ ] Test full learning hub flow ## 5. Community Page
Enhancement - [ ] &nbsp;Design forum database schema with future real-time messaging support - [ ]
&nbsp;Build infrastructure for message streaming service integration - [ ] &nbsp;Create
threads/posts/comments/reactions tables - [ ] &nbsp;Track all community metrics (posts, replies,
votes, etc.) - [ ] &nbsp;Link metrics to user profiles for activity tracking - [ ] &nbsp;Build forum UI
with thread/post display - [ ] &nbsp;Implement smart backlinks to relevant app sections - [ ]
&nbsp;Add user comment sections on lessons/resources - [ ] &nbsp;Design CommunityNavigation
with live features - [ ] &nbsp;Test community features and metric tracking ## 6. User Profile &
Progress Tracking - [ ] &nbsp;Design comprehensive progress database with efficient table merging
(Types defined) - [ ] Track every user activity: quizzes, lessons, tools, community (Progress tracked,
Activity Logs defined) - [ ] &nbsp;Ensure site-wide updates with no redundancy or mixups - [ ]
&nbsp;Build ProgressDashboard (user-specific, subscription-gated) (
UserDashboard&nbsp;implemented) - [ ] &nbsp;Create admin analytics view (anonymized,
educational insights) - [ ] &nbsp;Implement accurate mathematical/statistical progress calculations (
useUserAnalytics) - [ ] &nbsp;Generate analysis reports for admin dashboard - [ ] &nbsp;Build
visualizations: charts, graphs, heatmaps (Recharts integrated) - [ ] Test progress persistence and
accuracy across all activities - [ ] &nbsp;Integrate with existing admin dashboard ## 7.
Documentation & Planning - [ ] &nbsp;Create comprehensive implementation plan - [ ] Document
database schema changes - [ ] Create SQL migration scripts - [ ] &nbsp;Document API changes ## 8.
PHASE 1: Foundation (Code Complete) - [ ] &nbsp;Create comprehensive database migration - [ ]
&nbsp;Rename tables: course_modules â†’ modules, course_lessons â†’ classes - [ ] &nbsp;Create new
class_lessons table - [ ] &nbsp;Create music_categories table with seed data - [ ] &nbsp;Create
resource_libraries and library_resources tables - [ ] &nbsp;Create custom_purchases and pricing_tiers


--- PAGE 40 ---
tables - [ ] &nbsp;Create community tables (threads, posts, reactions, etc.) - [ ] &nbsp;Create progress
tracking tables - [ ] &nbsp;Add all triggers and functions - [ ] &nbsp;Test migration locally (User
Confirmed) -- ============================================ -- Saem's Tunes
Comprehensive Enhancement Migration -- Date: 2026-01-06 -- Purpose: Implement 4-level lesson
hierarchy, resource libraries, -- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;community infrastructure, and
comprehensive analytics -- ============================================ --
============================================ -- PART 1: RENAME EXISTING
TABLES FOR HIERARCHY -- ============================================ --
Rename course_modules to modules DO
BEGIN
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name =
'course_modules') THEN
Â  Â  Â  Â  ALTER TABLE course_modules RENAME TO modules;
Â  Â  Â  Â  ALTER INDEX IF EXISTS course_modules_pkey RENAME TO modules_pkey;
Â  Â  Â  Â  ALTER INDEX IF EXISTS idx_course_modules_course RENAME TO
idx_modules_course;
Â  Â  Â  Â  RAISE NOTICE 'Renamed course_modules to modules';
Â  Â  END IF;
END $$;
-- Rename course_lessons to classes
DO $$
BEGIN
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name =
'course_lessons') THEN
Â  Â  Â  Â  ALTER TABLE course_lessons RENAME TO classes;
Â  Â  Â  Â  ALTER INDEX IF EXISTS course_lessons_pkey RENAME TO classes_pkey;
Â  Â  Â  Â  ALTER INDEX IF EXISTS idx_course_lessons_module RENAME TO
idx_classes_module;
Â  Â  Â  Â  RAISE NOTICE 'Renamed course_lessons to classes';
Â  Â  END IF;
END $$;


--- PAGE 41 ---
-- Update column names in classes table
ALTER TABLE classes RENAME COLUMN module_id TO module_id; Â -- Already correct,
just verify
ALTER TABLE classes DROP COLUMN IF EXISTS content_type;
ALTER TABLE classes DROP COLUMN IF EXISTS content_url;
ALTER TABLE classes DROP COLUMN IF EXISTS is_free_preview;
-- ============================================
-- PART 2: CREATE NEW CLASS_LESSONS TABLE
-- ============================================
CREATE TABLE IF NOT EXISTS class_lessons (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  class_id UUID NOT NULL,
Â  Â  title TEXT NOT NULL,
Â  Â  description TEXT,
Â  Â  lesson_type TEXT NOT NULL,
Â  Â  content_url TEXT,
Â  Â  duration_minutes INTEGER DEFAULT 0,
Â  Â  order_index INTEGER DEFAULT 0,
Â  Â  is_preview BOOLEAN DEFAULT FALSE,
Â  Â  -- Resource indicators
Â  Â  has_pdf BOOLEAN DEFAULT FALSE,
Â  Â  has_audio BOOLEAN DEFAULT FALSE,
Â  Â  has_video BOOLEAN DEFAULT FALSE,
Â  Â  has_quiz BOOLEAN DEFAULT FALSE,
Â  Â  has_exercise BOOLEAN DEFAULT FALSE,
Â  Â  -- Comments enabled
Â  Â  comments_enabled BOOLEAN DEFAULT TRUE,


--- PAGE 42 ---
Â  Â  -- Metadata
Â  Â  thumbnail_url TEXT,
Â  Â  video_platform TEXT, -- 'youtube', 'vimeo', 'direct'
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT class_lessons_lesson_type_check CHECK (
Â  Â  Â  Â  lesson_type IN ('video', 'audio', 'text', 'interactive', 'practice', 'quiz', 'reading')
Â  Â  )
);
-- Add foreign key constraint (will be added after ensuring classes table exists)
DO $$
BEGIN
Â  Â  IF NOT EXISTS (
Â  Â  Â  Â  SELECT 1 FROM information_schema.table_constraints
Â  Â  Â  Â  WHERE constraint_name = 'class_lessons_class_id_fkey'
Â  Â  ) THEN
Â  Â  Â  Â  ALTER TABLE class_lessons
Â  Â  Â  Â  ADD CONSTRAINT class_lessons_class_id_fkey
Â  Â  Â  Â  FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE CASCADE;
Â  Â  END IF;
END $$;
CREATE INDEX IF NOT EXISTS idx_class_lessons_class ON class_lessons(class_id);
CREATE INDEX IF NOT EXISTS idx_class_lessons_order ON class_lessons(class_id,
order_index);
-- ============================================
-- PART 3: ENHANCED CATEGORIZATION SYSTEM
-- ============================================


--- PAGE 43 ---
-- Add music element categorization to courses
ALTER TABLE courses ADD COLUMN IF NOT EXISTS music_elements TEXT[] DEFAULT
'{}';
ALTER TABLE courses ADD COLUMN IF NOT EXISTS extended_category TEXT;
ALTER TABLE courses ADD COLUMN IF NOT EXISTS difficulty_level INTEGER DEFAULT
1;
ALTER TABLE courses ADD COLUMN IF NOT EXISTS prerequisites UUID[] DEFAULT '{}';
-- Add difficulty to modules and classes
ALTER TABLE modules ADD COLUMN IF NOT EXISTS difficulty_level INTEGER DEFAULT
1;
ALTER TABLE modules ADD COLUMN IF NOT EXISTS prerequisites UUID[] DEFAULT '{}';
ALTER TABLE classes ADD COLUMN IF NOT EXISTS difficulty_level INTEGER DEFAULT
1;
-- Music categories master table
CREATE TABLE IF NOT EXISTS music_categories (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  name TEXT NOT NULL UNIQUE,
Â  Â  category_type TEXT NOT NULL,
Â  Â  description TEXT,
Â  Â  icon TEXT,
Â  Â  color TEXT,
Â  Â  order_index INTEGER DEFAULT 0,
Â  Â  is_active BOOLEAN DEFAULT TRUE,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT music_categories_type_check CHECK (
Â  Â  Â  Â  category_type IN ('element', 'extended', 'specialty')
Â  Â  )


--- PAGE 44 ---
);
-- Seed the 8 elements of music + extended categories
INSERT INTO music_categories (name, category_type, description, order_index) VALUES
-- 8 Elements
('Rhythm', 'element', 'Pattern of sounds and silences in music', 1),
('Melody', 'element', 'Sequence of musical notes perceived as a single entity', 2),
('Harmony', 'element', 'Combination of simultaneously sounded musical notes', 3),
('Timbre', 'element', 'Quality or color of a musical sound', 4),
('Texture', 'element', 'The way melody, harmony and rhythm combine in music', 5),
('Form', 'element', 'Structure and design of a musical composition', 6),
('Dynamics', 'element', 'Volume of sound in music', 7),
('Tempo', 'element', 'Speed at which music is played', 8),
-- Extended Categories
('Music Business', 'extended', 'Industry knowledge, marketing, and career development', 9),
('Music Production', 'extended', 'Recording, mixing, and mastering techniques', 10),
('Music History', 'extended', 'Evolution and cultural context of music', 11),
('Composition', 'extended', 'Creating original musical works', 12),
('Performance', 'extended', 'Stage presence and performance technique', 13),
('Music Theory', 'extended', 'Notation, harmony, and musical analysis', 14),
('Songwriting', 'extended', 'Crafting lyrics and melodies', 15),
('Improvisation', 'extended', 'Spontaneous musical creation', 16)
ON CONFLICT (name) DO NOTHING;
-- ============================================
-- PART 4: RESOURCE LIBRARY SYSTEM
-- ============================================
CREATE TABLE IF NOT EXISTS resource_libraries (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),


--- PAGE 45 ---
Â  Â  -- Polymorphic association
Â  Â  entity_type TEXT NOT NULL,
Â  Â  entity_id UUID NOT NULL,
Â  Â  name TEXT NOT NULL,
Â  Â  description TEXT,
Â  Â  icon TEXT,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT resource_libraries_entity_type_check CHECK (
Â  Â  Â  Â  entity_type IN ('course', 'module', 'class', 'lesson')
Â  Â  )
);
CREATE UNIQUE INDEX IF NOT EXISTS idx_resource_libraries_entity
ON resource_libraries(entity_type, entity_id);
CREATE TABLE IF NOT EXISTS library_resources (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  library_id UUID REFERENCES resource_libraries(id) ON DELETE CASCADE,
Â  Â  title TEXT NOT NULL,
Â  Â  description TEXT,
Â  Â  resource_type TEXT NOT NULL,
Â  Â  resource_url TEXT NOT NULL,
Â  Â  file_size_mb NUMERIC(10,2),
Â  Â  -- Metadata
Â  Â  author TEXT,
Â  Â  duration_minutes INTEGER,
Â  Â  page_count INTEGER,
Â  Â  -- Access control


--- PAGE 46 ---
Â  Â  access_tier TEXT DEFAULT 'free',
Â  Â  is_public BOOLEAN DEFAULT TRUE,
Â  Â  -- Usage tracking
Â  Â  view_count INTEGER DEFAULT 0,
Â  Â  download_count INTEGER DEFAULT 0,
Â  Â  -- Tags for searchability
Â  Â  tags TEXT[] DEFAULT '{}',
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT library_resources_type_check CHECK (
Â  Â  Â  Â  resource_type IN ('pdf', 'audio', 'video', 'link', 'book', 'article', 'image', 'document', 'text')
Â  Â  ),
Â  Â  CONSTRAINT library_resources_access_check CHECK (
Â  Â  Â  Â  access_tier IN ('free', 'basic', 'premium', 'professional')
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_library_resources_library ON
library_resources(library_id);
CREATE INDEX IF NOT EXISTS idx_library_resources_type ON
library_resources(resource_type);
CREATE INDEX IF NOT EXISTS idx_library_resources_tags ON library_resources USING
GIN(tags);
-- ============================================
-- PART 5: CUSTOM PAYMENT & PRICING SYSTEM
-- ============================================
CREATE TABLE IF NOT EXISTS pricing_tiers (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  entity_type TEXT NOT NULL,


--- PAGE 47 ---
Â  Â  entity_id UUID NOT NULL,
Â  Â  -- Individual pricing
Â  Â  single_price NUMERIC(10,2) NOT NULL,
Â  Â  -- Bundle pricing (quantity discounts)
Â  Â  bundle_5_price NUMERIC(10,2),
Â  Â  bundle_10_price NUMERIC(10,2),
Â  Â  bundle_20_price NUMERIC(10,2),
Â  Â  -- Subscription options
Â  Â  monthly_price NUMERIC(10,2),
Â  Â  yearly_price NUMERIC(10,2),
Â  Â  is_active BOOLEAN DEFAULT TRUE,
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT pricing_tiers_entity_check CHECK (
Â  Â  Â  Â  entity_type IN ('lesson', 'class', 'module', 'course')
Â  Â  ),
Â  Â  UNIQUE(entity_type, entity_id)
);
CREATE INDEX IF NOT EXISTS idx_pricing_tiers_entity ON pricing_tiers(entity_type,
entity_id);
CREATE TABLE IF NOT EXISTS custom_purchases (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  -- Purchase composition (flexible selection)
Â  Â  selected_lessons UUID[] DEFAULT '{}',
Â  Â  selected_classes UUID[] DEFAULT '{}',
Â  Â  selected_modules UUID[] DEFAULT '{}',
Â  Â  selected_courses UUID[] DEFAULT '{}',


--- PAGE 48 ---
Â  Â  -- Pricing
Â  Â  total_items INTEGER NOT NULL,
Â  Â  base_price NUMERIC(10,2) NOT NULL,
Â  Â  tier_discount NUMERIC(5,2) DEFAULT 0,
Â  Â  final_price NUMERIC(10,2) NOT NULL,
Â  Â  currency TEXT DEFAULT 'KES',
Â  Â  -- Payment details
Â  Â  payment_status TEXT DEFAULT 'pending',
Â  Â  payment_method TEXT,
Â  Â  transaction_id TEXT,
Â  Â  payment_provider TEXT, -- 'mpesa', 'paypal', 'stripe'
Â  Â  -- Access control
Â  Â  access_granted_at TIMESTAMPTZ,
Â  Â  access_expires_at TIMESTAMPTZ,
Â  Â  is_lifetime_access BOOLEAN DEFAULT FALSE,
Â  Â  -- Metadata
Â  Â  notes TEXT,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT custom_purchases_payment_status_check CHECK (
Â  Â  Â  Â  payment_status IN ('pending', 'completed', 'failed', 'refunded', 'cancelled')
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_custom_purchases_user ON
custom_purchases(user_id);
CREATE INDEX IF NOT EXISTS idx_custom_purchases_status ON
custom_purchases(payment_status);
-- ============================================


--- PAGE 49 ---
-- PART 6: COMMUNITY INFRASTRUCTURE
-- ============================================
CREATE TABLE IF NOT EXISTS community_threads (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
Â  Â  title TEXT NOT NULL,
Â  Â  category TEXT NOT NULL,
Â  Â  tags TEXT[] DEFAULT '{}',
Â  Â  -- Thread properties
Â  Â  is_pinned BOOLEAN DEFAULT FALSE,
Â  Â  is_locked BOOLEAN DEFAULT FALSE,
Â  Â  is_announcement BOOLEAN DEFAULT FALSE,
Â  Â  -- Engagement metrics
Â  Â  view_count INTEGER DEFAULT 0,
Â  Â  reply_count INTEGER DEFAULT 0,
Â  Â  reaction_count INTEGER DEFAULT 0,
Â  Â  -- Smart backlinks to learning content
Â  Â  linked_course_id UUID REFERENCES courses(id) ON DELETE SET NULL,
Â  Â  linked_module_id UUID REFERENCES modules(id) ON DELETE SET NULL,
Â  Â  linked_class_id UUID REFERENCES classes(id) ON DELETE SET NULL,
Â  Â  linked_lesson_id UUID REFERENCES class_lessons(id) ON DELETE SET NULL,
Â  Â  -- Timestamps
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT community_threads_category_check CHECK (
Â  Â  Â  Â  category IN ('general', 'theory', 'practice', 'gear', 'performance',


--- PAGE 50 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 'composition', 'production', 'business', 'help', 'showcase')
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_threads_category ON community_threads(category);
CREATE INDEX IF NOT EXISTS idx_threads_user ON community_threads(user_id);
CREATE INDEX IF NOT EXISTS idx_threads_activity ON
community_threads(last_activity_at DESC);
CREATE INDEX IF NOT EXISTS idx_threads_links ON
community_threads(linked_course_id, linked_module_id);
CREATE INDEX IF NOT EXISTS idx_threads_tags ON community_threads USING
GIN(tags);
CREATE TABLE IF NOT EXISTS community_posts (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  thread_id UUID REFERENCES community_threads(id) ON DELETE CASCADE,
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
Â  Â  parent_post_id UUID REFERENCES community_posts(id) ON DELETE CASCADE,
Â  Â  content TEXT NOT NULL,
Â  Â  -- Post properties
Â  Â  is_solution BOOLEAN DEFAULT FALSE,
Â  Â  is_edited BOOLEAN DEFAULT FALSE,
Â  Â  edited_at TIMESTAMPTZ,
Â  Â  -- Metrics
Â  Â  reaction_count INTEGER DEFAULT 0,
Â  Â  reply_count INTEGER DEFAULT 0,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_posts_thread ON community_posts(thread_id);


--- PAGE 51 ---
CREATE INDEX IF NOT EXISTS idx_posts_user ON community_posts(user_id);
CREATE INDEX IF NOT EXISTS idx_posts_parent ON community_posts(parent_post_id);
-- Resource/Lesson Comments
CREATE TABLE IF NOT EXISTS resource_comments (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  -- Polymorphic reference
Â  Â  commentable_type TEXT NOT NULL,
Â  Â  commentable_id UUID NOT NULL,
Â  Â  content TEXT NOT NULL,
Â  Â  parent_comment_id UUID REFERENCES resource_comments(id) ON DELETE
CASCADE,
Â  Â  -- Metrics
Â  Â  likes_count INTEGER DEFAULT 0,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT resource_comments_type_check CHECK (
Â  Â  Â  Â  commentable_type IN ('resource', 'lesson', 'class', 'module', 'course')
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_resource_comments_entity
ON resource_comments(commentable_type, commentable_id);
CREATE INDEX IF NOT EXISTS idx_resource_comments_user ON
resource_comments(user_id);
-- Reactions system (polymorphic)
CREATE TABLE IF NOT EXISTS reactions (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,


--- PAGE 52 ---
Â  Â  -- Polymorphic target
Â  Â  reactable_type TEXT NOT NULL,
Â  Â  reactable_id UUID NOT NULL,
Â  Â  reaction_type TEXT NOT NULL,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT reactions_type_check CHECK (
Â  Â  Â  Â  reactable_type IN ('thread', 'post', 'comment', 'resource')
Â  Â  ),
Â  Â  CONSTRAINT reactions_reaction_check CHECK (
Â  Â  Â  Â  reaction_type IN ('like', 'love', 'helpful', 'inspiring', 'fire', 'celebrate')
Â  Â  ),
Â  Â  UNIQUE(user_id, reactable_type, reactable_id, reaction_type)
);
CREATE INDEX IF NOT EXISTS idx_reactions_entity ON reactions(reactable_type,
reactable_id);
CREATE INDEX IF NOT EXISTS idx_reactions_user ON reactions(user_id);
-- User community statistics
CREATE TABLE IF NOT EXISTS user_community_stats (
Â  Â  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  -- Participation
Â  Â  threads_created INTEGER DEFAULT 0,
Â  Â  posts_created INTEGER DEFAULT 0,
Â  Â  comments_created INTEGER DEFAULT 0,
Â  Â  -- Engagement
Â  Â  reactions_given INTEGER DEFAULT 0,
Â  Â  reactions_received INTEGER DEFAULT 0,
Â  Â  solutions_provided INTEGER DEFAULT 0,


--- PAGE 53 ---
Â  Â  -- Reputation
Â  Â  reputation_points INTEGER DEFAULT 0,
Â  Â  helpful_votes INTEGER DEFAULT 0,
Â  Â  -- Badges
Â  Â  badges TEXT[] DEFAULT '{}',
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
);
-- Real-time messaging infrastructure (future-ready)
CREATE TABLE IF NOT EXISTS conversations (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  -- Participants (supports group chats)
Â  Â  participant_ids UUID[] NOT NULL,
Â  Â  -- Conversation metadata
Â  Â  conversation_type TEXT DEFAULT 'direct',
Â  Â  title TEXT,
Â  Â  -- Last message info
Â  Â  last_message_at TIMESTAMPTZ,
Â  Â  last_message_content TEXT,
Â  Â  last_message_sender_id UUID,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT conversations_type_check CHECK (
Â  Â  Â  Â  conversation_type IN ('direct', 'group', 'support')
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_conversations_participants


--- PAGE 54 ---
ON conversations USING GIN(participant_ids);
CREATE TABLE IF NOT EXISTS direct_messages (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
Â  Â  sender_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  message TEXT NOT NULL,
Â  Â  -- Message status
Â  Â  is_read BOOLEAN DEFAULT FALSE,
Â  Â  read_at TIMESTAMPTZ,
Â  Â  -- Attachments
Â  Â  has_attachment BOOLEAN DEFAULT FALSE,
Â  Â  attachment_url TEXT,
Â  Â  attachment_type TEXT,
Â  Â  -- Reactions
Â  Â  reactions JSONB DEFAULT '[]',
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  CONSTRAINT direct_messages_attachment_check CHECK (
Â  Â  Â  Â  attachment_type IS NULL OR attachment_type IN ('image', 'audio', 'video', 'file')
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_dm_conversation ON
direct_messages(conversation_id);
CREATE INDEX IF NOT EXISTS idx_dm_sender ON direct_messages(sender_id);
CREATE INDEX IF NOT EXISTS idx_dm_unread ON direct_messages(conversation_id)
WHERE is_read = FALSE;
-- Thread subscriptions for notifications


--- PAGE 55 ---
CREATE TABLE IF NOT EXISTS thread_subscriptions (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  thread_id UUID REFERENCES community_threads(id) ON DELETE CASCADE,
Â  Â  notify_on_reply BOOLEAN DEFAULT TRUE,
Â  Â  notify_on_solution BOOLEAN DEFAULT TRUE,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  UNIQUE(user_id, thread_id)
);
CREATE INDEX IF NOT EXISTS idx_subscriptions_user ON thread_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_thread ON
thread_subscriptions(thread_id);
-- ============================================
-- PART 7: COMPREHENSIVE PROGRESS TRACKING
-- ============================================
-- Master user progress table (if not exists, create; if exists, add columns)
DO $$
BEGIN
Â  Â  CREATE TABLE IF NOT EXISTS user_progress (
Â  Â  Â  Â  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
Â  Â  );
END $$;
-- Add all progress columns
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS quiz_attempts_total
INTEGER DEFAULT 0;


--- PAGE 56 ---
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS quiz_perfect_scores
INTEGER DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS quiz_average_score
NUMERIC(5,2) DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS quiz_categories_mastered
TEXT[] DEFAULT '{}';
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS last_quiz_date
TIMESTAMPTZ;
-- Learning progress (4-level hierarchy)
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS courses_enrolled INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS courses_completed
INTEGER DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS modules_completed
INTEGER DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS classes_completed INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS lessons_completed INTEGER
DEFAULT 0;
-- Time tracking
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS total_study_time_minutes
INTEGER DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS avg_daily_study_minutes
NUMERIC(10,2) DEFAULT 0;
-- Streak tracking
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS current_streak_days
INTEGER DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS longest_streak_days
INTEGER DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS last_study_date DATE;
-- Music Elements Mastery (0-100 each)


--- PAGE 57 ---
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS rhythm_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS melody_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS harmony_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS timbre_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS texture_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS form_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS dynamics_mastery INTEGER
DEFAULT 0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS tempo_mastery INTEGER
DEFAULT 0;
-- Tool usage
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS tools_used TEXT[] DEFAULT
'{}';
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS favorite_tool TEXT;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS total_tool_sessions INTEGER
DEFAULT 0;
-- Achievements
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS total_xp INTEGER DEFAULT
0;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS level INTEGER DEFAULT 1;
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS achievements_unlocked
TEXT[] DEFAULT '{}';
-- Subscription analytics (for admin)
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS
subscription_revenue_generated NUMERIC(10,2) DEFAULT 0;


--- PAGE 58 ---
ALTER TABLE user_progress ADD COLUMN IF NOT EXISTS lifetime_value
NUMERIC(10,2) DEFAULT 0;
-- Detailed lesson tracking
CREATE TABLE IF NOT EXISTS user_lesson_tracking (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
Â  Â  -- 4-level hierarchy tracking
Â  Â  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
Â  Â  module_id UUID REFERENCES modules(id) ON DELETE CASCADE,
Â  Â  class_id UUID REFERENCES classes(id) ON DELETE CASCADE,
Â  Â  lesson_id UUID REFERENCES class_lessons(id) ON DELETE CASCADE,
Â  Â  -- Progress
Â  Â  started_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  completed_at TIMESTAMPTZ,
Â  Â  last_accessed_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  completion_percentage INTEGER DEFAULT 0,
Â  Â  time_spent_minutes INTEGER DEFAULT 0,
Â  Â  -- Lesson-specific
Â  Â  video_watched_percentage INTEGER DEFAULT 0,
Â  Â  quiz_attempts INTEGER DEFAULT 0,
Â  Â  quiz_best_score INTEGER DEFAULT 0,
Â  Â  quiz_passed BOOLEAN DEFAULT FALSE,
Â  Â  -- Resources
Â  Â  resources_viewed UUID[] DEFAULT '{}',
Â  Â  resources_downloaded UUID[] DEFAULT '{}',
Â  Â  -- User notes
Â  Â  personal_notes TEXT,


--- PAGE 59 ---
Â  Â  bookmarked BOOLEAN DEFAULT FALSE,
Â  Â  difficulty_rating INTEGER,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  UNIQUE(user_id, lesson_id),
Â  Â  CONSTRAINT user_lesson_tracking_completion_check CHECK (
Â  Â  Â  Â  completion_percentage >= 0 AND completion_percentage <= 100
Â  Â  ),
Â  Â  CONSTRAINT user_lesson_tracking_video_check CHECK (
Â  Â  Â  Â  video_watched_percentage >= 0 AND video_watched_percentage <= 100
Â  Â  ),
Â  Â  CONSTRAINT user_lesson_tracking_rating_check CHECK (
Â  Â  Â  Â  difficulty_rating IS NULL OR (difficulty_rating >= 1 AND difficulty_rating <= 5)
Â  Â  )
);
CREATE INDEX IF NOT EXISTS idx_user_lesson_user ON user_lesson_tracking(user_id);
CREATE INDEX IF NOT EXISTS idx_user_lesson_course ON
user_lesson_tracking(course_id);
CREATE INDEX IF NOT EXISTS idx_user_lesson_module ON
user_lesson_tracking(module_id);
CREATE INDEX IF NOT EXISTS idx_user_lesson_class ON
user_lesson_tracking(class_id);
CREATE INDEX IF NOT EXISTS idx_user_lesson_completed ON
user_lesson_tracking(user_id, completed_at);
-- Study session analytics
CREATE TABLE IF NOT EXISTS user_study_sessions (
Â  Â  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
Â  Â  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,


--- PAGE 60 ---
Â  Â  session_date DATE NOT NULL,
Â  Â  session_start TIME NOT NULL,
Â  Â  session_end TIME,
Â  Â  duration_minutes INTEGER,
Â  Â  -- Activities
Â  Â  lessons_accessed UUID[] DEFAULT '{}',
Â  Â  tools_used TEXT[] DEFAULT '{}',
Â  Â  resources_viewed UUID[] DEFAULT '{}',
Â  Â  -- Engagement metrics
Â  Â  videos_watched INTEGER DEFAULT 0,
Â  Â  quizzes_taken INTEGER DEFAULT 0,
Â  Â  notes_written INTEGER DEFAULT 0,
Â  Â  forum_posts INTEGER DEFAULT 0,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  UNIQUE(user_id, session_date, session_start)
);
CREATE INDEX IF NOT EXISTS idx_study_sessions_user_date
ON user_study_sessions(user_id, session_date DESC);
-- ============================================
-- PART 8: TRIGGERS & FUNCTIONS
-- ============================================
-- Update thread metrics on new post
CREATE OR REPLACE FUNCTION update_thread_metrics()
RETURNS TRIGGER AS $$
BEGIN
Â  Â  UPDATE community_threads
Â  Â  SET


--- PAGE 61 ---
Â  Â  Â  Â  reply_count = (SELECT COUNT(*) FROM community_posts WHERE thread_id =
NEW.thread_id),
Â  Â  Â  Â  last_activity_at = NOW(),
Â  Â  Â  Â  updated_at = NOW()
Â  Â  WHERE id = NEW.thread_id;
Â  Â  -- Update user community stats
Â  Â  INSERT INTO user_community_stats (user_id, posts_created)
Â  Â  VALUES (NEW.user_id, 1)
Â  Â  ON CONFLICT (user_id) DO UPDATE
Â  Â  SET posts_created = user_community_stats.posts_created + 1,
Â  Â  Â  Â  updated_at = NOW();
Â  Â  RETURN NEW;
END;
BEGIN
Â  Â  IF NEW.completed_at IS NOT NULL AND (OLD.completed_at IS NULL OR OLD IS NULL)
THEN
Â  Â  Â  Â  UPDATE user_progress
Â  Â  Â  Â  SET
Â  Â  Â  Â  Â  Â  lessons_completed = lessons_completed + 1,
Â  Â  Â  Â  Â  Â  last_study_date = CURRENT_DATE,
Â  Â  Â  Â  Â  Â  updated_at = NOW()
Â  Â  Â  Â  WHERE user_id = NEW.user_id;
Â  Â  END IF;
Â  Â  RETURN NEW;
END;
DECLARE
Â  Â  current_streak INTEGER := 0;
Â  Â  last_date DATE;


--- PAGE 62 ---
Â  Â  check_date DATE;
BEGIN
Â  Â  SELECT MAX(session_date) INTO last_date
Â  Â  FROM user_study_sessions
Â  Â  WHERE user_id = p_user_id;
Â  Â  IF last_date IS NULL THEN
Â  Â  Â  Â  RETURN 0;
Â  Â  END IF;
Â  Â  -- Check if streak is broken (no activity yesterday or today)
Â  Â  IF last_date < CURRENT_DATE - INTERVAL '1 day' THEN
Â  Â  Â  Â  RETURN 0;
Â  Â  END IF;
Â  Â  check_date := last_date;
Â  Â  WHILE EXISTS (
Â  Â  Â  Â  SELECT 1 FROM user_study_sessions
Â  Â  Â  Â  WHERE user_id = p_user_id AND session_date = check_date
Â  Â  ) LOOP
Â  Â  Â  Â  current_streak := current_streak + 1;
Â  Â  Â  Â  check_date := check_date - INTERVAL '1 day';
Â  Â  END LOOP;
Â  Â  RETURN current_streak;
END;
BEGIN
Â  Â  NEW.updated_at = NOW();
Â  Â  RETURN NEW;
END;
DECLARE


--- PAGE 63 ---
Â  Â  t TEXT;
BEGIN
Â  Â  FOR t IN
Â  Â  Â  Â  SELECT c.table_name
Â  Â  Â  Â  FROM information_schema.columns c
Â  Â  Â  Â  JOIN information_schema.tables t
Â  Â  Â  Â  Â  ON c.table_schema = t.table_schema
Â  Â  Â  Â  Â AND c.table_name = t.table_name
Â  Â  Â  Â  WHERE c.column_name = 'updated_at'
Â  Â  Â  Â  Â  AND c.table_schema = 'public'
Â  Â  Â  Â  Â  AND t.table_type = 'BASE TABLE' Â -- This excludes views
Â  Â  LOOP
Â  Â  Â  Â  EXECUTE format('
Â  Â  Â  Â  Â  Â  DROP TRIGGER IF EXISTS set_timestamp ON %I;
Â  Â  Â  Â  Â  Â  CREATE TRIGGER set_timestamp
Â  Â  Â  Â  Â  Â  BEFORE UPDATE ON %I
Â  Â  Â  Â  Â  Â  FOR EACH ROW
Â  Â  Â  Â  Â  Â  EXECUTE FUNCTION trigger_set_timestamp();
Â  Â  Â  Â  ', t, t);
Â  Â  END LOOP;
END $$;
-- ============================================
-- PART 9: ADMIN ANALYTICS VIEW
-- ============================================
CREATE OR REPLACE VIEW admin_user_analytics AS
SELECT
Â  Â  -- Anonymized user identifier


--- PAGE 64 ---
Â  Â  SUBSTRING(u.id::TEXT, 1, 8) || '****' AS anonymized_user_id,
Â  Â  -- Subscription info
Â  Â  p.subscription_tier,
Â  Â  p.role AS user_role,
Â  Â  -- Progress metrics
Â  Â  up.level AS user_level,
Â  Â  up.total_xp,
Â  Â  up.courses_enrolled,
Â  Â  up.courses_completed,
Â  Â  up.modules_completed,
Â  Â  up.classes_completed,
Â  Â  up.lessons_completed,
Â  Â  up.total_study_time_minutes,
Â  Â  up.current_streak_days,
Â  Â  up.longest_streak_days,
Â  Â  up.avg_daily_study_minutes,
Â  Â  -- Music element proficiency
Â  Â  ROUND((
Â  Â  Â  Â  COALESCE(up.rhythm_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.melody_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.harmony_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.timbre_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.texture_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.form_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.dynamics_mastery, 0) +
Â  Â  Â  Â  COALESCE(up.tempo_mastery, 0)
Â  Â  ) / 8.0, 2) AS avg_element_mastery,


--- PAGE 65 ---
Â  Â  -- Engagement score
Â  Â  ROUND(
Â  Â  Â  Â  (COALESCE(up.quiz_attempts_total, 0) * 0.2) +
Â  Â  Â  Â  (COALESCE(up.lessons_completed, 0) * 0.3) +
Â  Â  Â  Â  (COALESCE(up.current_streak_days, 0) * 0.5) +
Â  Â  Â  Â  (COALESCE(ucs.posts_created, 0) * 0.1) +
Â  Â  Â  Â  (COALESCE(ucs.reputation_points, 0) * 0.05),
Â  Â  Â  Â  2
Â  Â  ) AS engagement_score,
Â  Â  -- Community engagement
Â  Â  COALESCE(ucs.threads_created, 0) AS threads_created,
Â  Â  COALESCE(ucs.posts_created, 0) AS posts_created,
Â  Â  COALESCE(ucs.reputation_points, 0) AS community_reputation,
Â  Â  -- Revenue metrics
Â  Â  up.subscription_revenue_generated,
Â  Â  up.lifetime_value,
Â  Â  -- Timestamps
Â  Â  DATE(up.created_at) AS joined_date,
Â  Â  up.last_study_date,
Â  Â  -- Activity indicators
Â  Â  CASE
Â  Â  Â  Â  WHEN up.last_study_date >= CURRENT_DATE - INTERVAL '7 days' THEN 'active'
Â  Â  Â  Â  WHEN up.last_study_date >= CURRENT_DATE - INTERVAL '30 days' THEN
'occasional'
Â  Â  Â  Â  ELSE 'inactive'
Â  Â  END AS activity_status
FROM auth.users u


--- PAGE 66 ---
LEFT JOIN profiles p ON p.id = u.id
LEFT JOIN user_progress up ON up.user_id = u.id
LEFT JOIN user_community_stats ucs ON ucs.user_id = u.id
WHERE u.deleted_at IS NULL;
-- Row Level Security for admin view
ALTER VIEW admin_user_analytics OWNER TO postgres;
-- ============================================
-- MIGRATION COMPLETE
-- ============================================
-- Log migration completion
DO $$
BEGIN
Â  Â  RAISE NOTICE 'Comprehensive enhancement migration completed successfully!';
Â  Â  RAISE NOTICE 'Tables created/updated:';
Â  Â  RAISE NOTICE ' Â - modules (renamed from course_modules)';
Â  Â  RAISE NOTICE ' Â - classes (renamed from course_lessons)';
Â  Â  RAISE NOTICE ' Â - class_lessons (NEW)';
Â  Â  RAISE NOTICE ' Â - music_categories (NEW)';
Â  Â  RAISE NOTICE ' Â - resource_libraries, library_resources (NEW)';
Â  Â  RAISE NOTICE ' Â - pricing_tiers, custom_purchases (NEW)';
Â  Â  RAISE NOTICE ' Â - community_threads, community_posts, reactions (NEW)';
Â  Â  RAISE NOTICE ' Â - user_community_stats (NEW)';
Â  Â  RAISE NOTICE ' Â - user_progress (enhanced)';
Â  Â  RAISE NOTICE ' Â - user_lesson_tracking (NEW)';
Â  Â  RAISE NOTICE ' Â - user_study_sessions (NEW)';
Â  Â  RAISE NOTICE 'Triggers and functions created.';
Â  Â  RAISE NOTICE 'Admin analytics view created.';


--- PAGE 67 ---
END $$;
[
import React, { useState, useEffect } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import MainLayout from '@/components/layout/MainLayout';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from
'@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import {
Â  ArrowLeft, CheckCircle, Play, Clock, BookOpen, Music, Award,
Â  ChevronDown, ChevronRight, Lock
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { useCourseDetails, CourseDetails } from '@/hooks/useCourseDetails';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from
'@/components/ui/collapsible';
import LessonViewer from '@/components/learning/LessonViewer';
import ResourceList from '@/components/learning/ResourceList';
import PurchaseModal from '@/components/payment/PurchaseModal';
import { usePayment } from '@/hooks/usePayment';
const LearningModulePage = () => {
Â  const { id } = useParams();
Â  const navigate = useNavigate();
Â  const { data: course, isLoading, error } = useCourseDetails(id);
Â  const { checkAccess } = usePayment();


--- PAGE 68 ---
Â  // State for navigation
Â  const [activeModuleId, setActiveModuleId] = useState<string | null>(null);
Â  const [activeClassId, setActiveClassId] = useState<string | null>(null);
Â  const [activeLessonId, setActiveLessonId] = useState<string | null>(null);
Â  const [expandedModules, setExpandedModules] = useState<Record<string, boolean>>({});
Â  // Access Control
Â  const [hasAccess, setHasAccess] = useState(false);
Â  const [showPurchaseModal, setShowPurchaseModal] = useState(false);
Â  // Check access
Â  useEffect(() => {
Â  Â  if (course) {
Â  Â  Â  if (course.access_level === 'free') {
Â  Â  Â  Â  setHasAccess(true);
Â  Â  Â  } else {
Â  Â  Â  Â  // Check if user bought it (mock logic in hook)
Â  Â  Â  Â  checkAccess('course', course.id).then(setHasAccess);
Â  Â  Â  }
Â  Â  }
Â  }, [course]);
Â  // Initialize selection when data loads
Â  useEffect(() => {
Â  Â  if (course && course.modules.length > 0) {
Â  Â  Â  if (!activeModuleId) {
Â  Â  Â  Â  const firstModule = course.modules[0];
Â  Â  Â  Â  setActiveModuleId(firstModule.id);
Â  Â  Â  Â  setExpandedModules(prev => ({ ...prev, [firstModule.id]: true }));
Â  Â  Â  Â  if (firstModule.classes.length > 0) {


--- PAGE 69 ---
Â  Â  Â  Â  Â  setActiveClassId(firstModule.classes[0].id);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  }, [course]);
Â  const toggleModule = (modId: string) => {
Â  Â  setExpandedModules(prev => ({
Â  Â  Â  ...prev,
Â  Â  Â  [modId]: !prev[modId]
Â  Â  }));
Â  };
Â  if (isLoading) {
Â  Â  return (
Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â 
Â  Â  );
Â  }
Â  if (error || !course) {
Â  Â  return (
Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â 
Error Loading Course


--- PAGE 70 ---
Â  Â  Â  Â  Â 
The requested course could not be found or failed to load.
Â  Â  Â  Â  Â  <Button onClick={() => navigate('/learning-hub')} className="mt-4">
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Back to Learning Hub
Â  Â  Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â 
Â  Â  );
Â  }
Â  // Find active content
Â  const currentModule = course.modules.find(m => m.id === activeModuleId);
Â  const currentClass = currentModule?.classes.find(c => c.id === activeClassId);
Â  const currentLesson = currentClass?.lessons.find(l => l.id === activeLessonId);
Â  return (
Â  Â 
Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â  {/ Header /}
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Return to Learning Hub
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 71 ---
{course.title}
Â  Â  Â  Â  Â  Â  Â  Â 
{course.description}
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  {course.access_level !== 'free' && (
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  {course.access_level.toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  {course.duration_minutes || 0} mins
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  {course.modules.length} Modules
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Your Progress
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  {/ TODO: Hook up real progress /}
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â 


--- PAGE 72 ---
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  {/ Sidebar Navigation /}
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Course Content
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  {course.modules.map((module) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Collapsible
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  key={module.id}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  open={expandedModules[module.id]}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onOpenChange={() => toggleModule(module.id)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="border-b last:border-0"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {expandedModules[module.id] ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 73 ---
{module.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
{module.classes.length} classes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {module.classes.map((cls) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setActiveModuleId(module.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setActiveClassId(cls.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setActiveLessonId(null); // Reset lesson selection when changing
class
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className={cn(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "w-full flex items-center gap-3 p-3 pl-11 text-sm hover:bg-muted
transition-colors text-left border-l-2 border-transparent",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeClassId === cls.id
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? "bg-gold/10 border-gold text-gold-dark font-medium"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : "text-muted-foreground"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {activeClassId === cls.id ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 74 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  {/ Main Content Area /}
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  {currentClass ? (
Â  Â  Â  Â  Â  Â  Â  Â  <>
Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentLesson ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  variant="ghost"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  className="w-fit mb-2 pl-0 hover:pl-2 transition-all"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setActiveLessonId(null)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {cls.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 75 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Back to Class Overview
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentLesson.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentClass.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <LessonViewer
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson={currentLesson}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  context={{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courseId: course.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  moduleId: activeModuleId!,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  classId: activeClassId!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onComplete={() => setActiveLessonId(null)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentModule?.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 76 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentClass.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentClass.description}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentClass.lessons.length > 0 ? (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentClass.lessons.map((lesson, idx) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {idx + 1}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
{lesson.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {lesson.lesson_type}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {lesson.duration_minutes} mins
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size="sm"


--- PAGE 77 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  variant="secondary"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick={() => setActiveLessonId(lesson.id)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Start
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
No lessons available for this class yet.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  </>
Â  Â  Â  Â  Â  Â  Â  ) : (
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 78 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Select a class from the menu to start learning
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â 
Â  Â 
Â  );
};
export default LearningModulePage;]
[
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/context/AuthContext";
import { supabase } from "@/integrations/supabase/client";
import { DatabaseCustom } from "@/types/database.custom";
import { SupabaseClient } from "@supabase/supabase-js";
import { toast } from "sonner";
type PurchaseEntity = 'course' | 'module' | 'class';
export const usePayment = () => {
Â  const { user } = useAuth();
Â  const queryClient = useQueryClient();
Â  const supabaseCustom = supabase as unknown as SupabaseClient;
Â  // Check if user has access to a specific entity


--- PAGE 79 ---
Â  const checkAccess = async (entityType: PurchaseEntity, entityId: string) => {
Â  Â  if (!user) return false;
Â  Â  // 1. Check direct purchase
Â  Â  const { data: purchase } = await supabaseCustom
Â  Â  Â  .from("custom_purchases")
Â  Â  Â  .select("*")
Â  Â  Â  .eq("user_id", user.id)
Â  Â  Â  .eq("payment_status", "completed")
Â  Â  Â  .contains(
Â  Â  Â  Â  entityType === 'course' ? 'selected_courses' :
Â  Â  Â  Â  Â  entityType === 'module' ? 'selected_modules' : 'selected_classes',
Â  Â  Â  Â  [entityId]
Â  Â  Â  )
Â  Â  Â  .maybeSingle();
Â  Â  if (purchase) return true;
Â  Â  // 2. Check if part of a parent purchase (e.g. bought course, so has module access)
Â  Â  // This is complex to check client-side without recursive queries.
Â  Â  // For now, we rely on the component to check parent access or we implement a server
function.
Â  Â  // Simplified: We assume access is granted explicity or via subscription tier (handled in
AuthContext/Profile).
Â  Â  return false;
Â  };
Â  // Create intent
Â  const initiatePurchase = useMutation({
Â  Â  mutationFn: async ({
Â  Â  Â  items,
Â  Â  Â  totalAmount,


--- PAGE 80 ---
Â  Â  Â  currency = 'KES'
Â  Â  }: {
Â  Â  Â  items: { type: PurchaseEntity, id: string }[],
Â  Â  Â  totalAmount: number,
Â  Â  Â  currency?: string
Â  Â  }) => {
Â  Â  Â  if (!user) throw new Error("User not confirmed");
Â  Â  Â  const courses = items.filter(i => i.type === 'course').map(i => i.id);
Â  Â  Â  const modules = items.filter(i => i.type === 'module').map(i => i.id);
Â  Â  Â  const classes = items.filter(i => i.type === 'class').map(i => i.id);
Â  Â  Â  const { data, error } = await supabaseCustom
Â  Â  Â  Â  .from("custom_purchases")
Â  Â  Â  Â  .insert({
Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  selected_courses: courses,
Â  Â  Â  Â  Â  selected_modules: modules,
Â  Â  Â  Â  Â  selected_classes: classes,
Â  Â  Â  Â  Â  total_items: items.length,
Â  Â  Â  Â  Â  base_price: totalAmount,
Â  Â  Â  Â  Â  final_price: totalAmount,
Â  Â  Â  Â  Â  currency,
Â  Â  Â  Â  Â  payment_status: 'pending',
Â  Â  Â  Â  Â  payment_method: 'mock_provider'
Â  Â  Â  Â  })
Â  Â  Â  Â  .select()
Â  Â  Â  Â  .single();
Â  Â  Â  if (error) throw error;


--- PAGE 81 ---
Â  Â  Â  return data;
Â  Â  },
Â  Â  onSuccess: (data) => {
Â  Â  Â  // Typically redirect to payment gateway here
Â  Â  Â  console.log("Purchase initiated:", data.id);
Â  Â  }
Â  });
Â  // Mock confirm
Â  const confirmPurchase = useMutation({
Â  Â  mutationFn: async (purchaseId: string) => {
Â  Â  Â  const { data, error } = await supabaseCustom
Â  Â  Â  Â  .from("custom_purchases")
Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  payment_status: 'completed',
Â  Â  Â  Â  Â  access_granted_at: new Date().toISOString(),
Â  Â  Â  Â  Â  transactionid: `txn${Math.random().toString(36).substring(7)}`
Â  Â  Â  Â  })
Â  Â  Â  Â  .eq("id", purchaseId)
Â  Â  Â  Â  .select()
Â  Â  Â  Â  .single();
Â  Â  Â  if (error) throw error;
Â  Â  Â  // Also update user profile to 'basic' or 'premium' if it was a sub?
Â  Â  Â  // For valid content access, we might update enrollment.
Â  Â  Â  return data;
Â  Â  },
Â  Â  onSuccess: () => {
Â  Â  Â  toast.success("Purchase successful! Content unlocked.");


--- PAGE 82 ---
Â  Â  Â  queryClient.invalidateQueries({ queryKey: ["learning-content"] });
Â  Â  Â  queryClient.invalidateQueries({ queryKey: ["course-details"] });
Â  Â  }
Â  });
Â  return {
Â  Â  initiatePurchase,
Â  Â  confirmPurchase,
Â  Â  checkAccess
Â  };
};]
[
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter }
from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Loader2, Lock, CreditCard, Check } from 'lucide-react';
import { usePayment } from '@/hooks/usePayment';
interface PurchaseModalProps {
Â  Â  isOpen: boolean;
Â  Â  onClose: () => void;
Â  Â  item: {
Â  Â  Â  Â  id: string;
Â  Â  Â  Â  title: string;
Â  Â  Â  Â  type: 'course' | 'module' | 'class';
Â  Â  Â  Â  price: number;
Â  Â  Â  Â  description?: string;
Â  Â  };


--- PAGE 83 ---
}
const PurchaseModal: React.FC = ({ isOpen, onClose, item }) => {
Â  Â  const { initiatePurchase, confirmPurchase } = usePayment();
Â  Â  const [step, setStep] = useState<'summary' | 'processing' | 'success'>('summary');
Â  Â  const [pendingPurchaseId, setPendingPurchaseId] = useState<string | null>(null);
Â  Â  const handlePurchase = () => {
Â  Â  Â  Â  initiatePurchase.mutate({
Â  Â  Â  Â  Â  Â  items: [{ type: item.type, id: item.id }],
Â  Â  Â  Â  Â  Â  totalAmount: item.price
Â  Â  Â  Â  }, {
Â  Â  Â  Â  Â  Â  onSuccess: (data) => {
Â  Â  Â  Â  Â  Â  Â  Â  setPendingPurchaseId(data.id);
Â  Â  Â  Â  Â  Â  Â  Â  setStep('processing');
Â  Â  Â  Â  Â  Â  Â  Â  // Simulate payment gateway delay then confirm
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmPurchase.mutate(data.id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onSuccess: () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setStep('success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };
Â  Â  const handleClose = () => {
Â  Â  Â  Â  setStep('summary');
Â  Â  Â  Â  setPendingPurchaseId(null);


--- PAGE 84 ---
Â  Â  Â  Â  onClose();
Â  Â  };
Â  Â  return (
Â  Â  Â  Â 
Â  Â  );
};
export default PurchaseModal;]
[export type Json =
Â  Â  | string
Â  Â  | number
Â  Â  | boolean
Â  Â  | null
Â  Â  | { [key: string]: Json | undefined }
Â  Â  | Json[]
export interface DatabaseCustom {
Â  Â  public: {
Â  Â  Â  Â  Tables: {
Â  Â  Â  Â  Â  Â  modules: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_level: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'success' ? 'Purchase Successful!' : 'Unlock Content'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'summary' && "Review your selection and proceed to payment."}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'processing' && "Processing your secure payment..."}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'success' && "You now have full access to this content."}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'summary' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
{item.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
{item.type}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 


--- PAGE 85 ---
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_level?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_level?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  classes: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  module_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  KES {item.price.toLocaleString()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {item.description && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
{item.description}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'processing' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Connecting to payment provider...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'success' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Thank you for your purchase!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}


--- PAGE 86 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_level: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  module_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_level?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  module_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_level?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'summary' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {step === 'success' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Start LearningÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {initiatePurchase.isPending ? : }Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Confirm Payment of KES {item.price.toLocaleString()


--- PAGE 87 ---
Â  Â  Â  Â  Â  Â  class_lessons: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson_type: 'video' | 'audio' | 'text' | 'interactive' | 'practice' | 'quiz' | 'reading'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content_url: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_preview: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_pdf: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_audio: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_video: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_quiz: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_exercise: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comments_enabled: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  thumbnail_url: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video_platform: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null


--- PAGE 88 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson_type: 'video' | 'audio' | 'text' | 'interactive' | 'practice' | 'quiz' | 'reading'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_preview?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_pdf?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_audio?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_video?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_quiz?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_exercise?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comments_enabled?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  thumbnail_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video_platform?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson_type?: 'video' | 'audio' | 'text' | 'interactive' | 'practice' | 'quiz' | 'reading'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_preview?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_pdf?: boolean


--- PAGE 89 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_audio?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_video?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_quiz?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  has_exercise?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comments_enabled?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  thumbnail_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video_platform?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  music_categories: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category_type: 'element' | 'extended' | 'specialty'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_active: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: string


--- PAGE 90 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category_type: 'element' | 'extended' | 'specialty'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_active?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category_type?: 'element' | 'extended' | 'specialty'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_index?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_active?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  courses: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null


--- PAGE 91 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  instructor_id: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level: 'beginner' | 'intermediate' | 'advanced' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_level: 'free' | 'basic' | 'premium' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  thumbnail_url: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview_video_url: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_published: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  music_elements: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  extended_category: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prerequisites: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  instructor_id?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level?: 'beginner' | 'intermediate' | 'advanced' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_level?: 'free' | 'basic' | 'premium' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  thumbnail_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview_video_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_published?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  music_elements?: string[] | null


--- PAGE 92 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  extended_category?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prerequisites?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  instructor_id?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  level?: 'beginner' | 'intermediate' | 'advanced' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_level?: 'free' | 'basic' | 'premium' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  thumbnail_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview_video_url?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_published?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  music_elements?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  extended_category?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prerequisites?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  resource_libraries: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string


--- PAGE 93 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type: 'course' | 'module' | 'class' | 'lesson'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type: 'course' | 'module' | 'class' | 'lesson'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type?: 'course' | 'module' | 'class' | 'lesson'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string


--- PAGE 94 ---
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  library_resources: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  library_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource_type: 'pdf' | 'audio' | 'video' | 'link' | 'book' | 'article' | 'image' | 'document'
| 'text'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource_url: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file_size_mb: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  author: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  page_count: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_tier: 'free' | 'basic' | 'premium' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_public: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  view_count: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  download_count: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tags: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  library_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: string


--- PAGE 95 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource_type: 'pdf' | 'audio' | 'video' | 'link' | 'book' | 'article' | 'image' | 'document'
| 'text'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource_url: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file_size_mb?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  author?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  page_count?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_tier?: 'free' | 'basic' | 'premium' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_public?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  view_count?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  download_count?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tags?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  library_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource_type?: 'pdf' | 'audio' | 'video' | 'link' | 'book' | 'article' | 'image' |
'document' | 'text'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource_url?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file_size_mb?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  author?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration_minutes?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  page_count?: number | null


--- PAGE 96 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_tier?: 'free' | 'basic' | 'premium' | 'professional'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_public?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  view_count?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  download_count?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tags?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  pricing_tiers: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type: 'lesson' | 'class' | 'module' | 'course'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  single_price: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_5_price: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_10_price: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_20_price: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthly_price: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yearly_price: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_active: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type: 'lesson' | 'class' | 'module' | 'course'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id: string


--- PAGE 97 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  single_price: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_5_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_10_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_20_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthly_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yearly_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_active?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type?: 'lesson' | 'class' | 'module' | 'course'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  single_price?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_5_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_10_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bundle_20_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthly_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yearly_price?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_active?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  custom_purchases: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string


--- PAGE 98 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_lessons: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_classes: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_modules: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_courses: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_items: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  base_price: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tier_discount: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final_price: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currency: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_status: 'pending' | 'completed' | 'failed' | 'refunded' | 'cancelled' | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_method: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction_id: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_provider: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_granted_at: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_expires_at: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_lifetime_access: boolean | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notes: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_lessons?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_classes?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_modules?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_courses?: string[] | null


--- PAGE 99 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_items: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  base_price: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tier_discount?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final_price: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currency?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_status?: 'pending' | 'completed' | 'failed' | 'refunded' | 'cancelled' | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_method?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction_id?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_provider?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_granted_at?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_expires_at?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_lifetime_access?: boolean | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notes?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_lessons?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_classes?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_modules?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected_courses?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_items?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  base_price?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tier_discount?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final_price?: number


--- PAGE 100 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currency?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_status?: 'pending' | 'completed' | 'failed' | 'refunded' | 'cancelled' | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_method?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction_id?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payment_provider?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_granted_at?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  access_expires_at?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_lifetime_access?: boolean | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notes?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  user_lesson_tracking: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  module_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  started_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed_at: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_accessed_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completion_percentage: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time_spent_minutes: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string


--- PAGE 101 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video_watched_percentage: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_attempts: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_best_score: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_passed: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  personal_notes: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bookmarked: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_rating: number | null
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  module_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  started_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed_at?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_accessed_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completion_percentage?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time_spent_minutes?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video_watched_percentage?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_attempts?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_best_score?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_passed?: boolean


--- PAGE 102 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  personal_notes?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bookmarked?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_rating?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  module_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lesson_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  started_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed_at?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_accessed_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completion_percentage?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time_spent_minutes?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updated_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video_watched_percentage?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_attempts?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_best_score?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quiz_passed?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  personal_notes?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bookmarked?: boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  difficulty_rating?: number | null
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },


--- PAGE 103 ---
Â  Â  Â  Â  Â  Â  user_progress: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courses_enrolled: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courses_completed: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modules_completed: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  classes_completed: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lessons_completed: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_study_time_minutes: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  current_streak_days: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_study_date: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  learning_progress: Json | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed_courses: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courses_enrolled?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courses_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modules_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  classes_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lessons_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_study_time_minutes?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  current_streak_days?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_study_date?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  learning_progress?: Json | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed_courses?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  }


--- PAGE 104 ---
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courses_enrolled?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  courses_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modules_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  classes_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lessons_completed?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_study_time_minutes?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  current_streak_days?: number
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_study_date?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  learning_progress?: Json | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed_courses?: string[] | null
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  activity_logs: {
Â  Â  Â  Â  Â  Â  Â  Â  Row: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activity_type: 'login' | 'lesson_start' | 'lesson_complete' | 'quiz_attempt' |
'course_enroll' | 'resource_download'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  metadata: Json | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Insert: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string


--- PAGE 105 ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activity_type: 'login' | 'lesson_start' | 'lesson_complete' | 'quiz_attempt' |
'course_enroll' | 'resource_download'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  metadata?: Json | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Update: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id?: string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activity_type?: 'login' | 'lesson_start' | 'lesson_complete' | 'quiz_attempt' |
'course_enroll' | 'resource_download'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_type?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entity_id?: string | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  metadata?: Json | null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at?: string
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
}]
[
import { useQuery } from "@tanstack/react-query";
import { supabase } from "@/integrations/supabase/client";
import { DatabaseCustom } from "@/types/database.custom";
import { SupabaseClient } from "@supabase/supabase-js";
type ResourceLibrary = DatabaseCustom["public"]["Tables"]["resource_libraries"]["Row"];


--- PAGE 106 ---
type LibraryResource = DatabaseCustom["public"]["Tables"]["library_resources"]["Row"];
export type ResourceEntityType = 'course' | 'module' | 'class' | 'lesson';
export const useResourceLibrary = (entityType: ResourceEntityType, entityId: string |
undefined) => {
Â  Â  const supabaseCustom = supabase as unknown as SupabaseClient;
Â  Â  // 1. Fetch the Library ID for this entity
Â  Â  const { data: library, isLoading: isLibraryLoading } = useQuery({
Â  Â  Â  Â  queryKey: ["resource-library", entityType, entityId],
Â  Â  Â  Â  queryFn: async () => {
Â  Â  Â  Â  Â  Â  if (!entityId) return null;
Â  Â  Â  Â  Â  Â  const { data, error } = await supabaseCustom
Â  Â  Â  Â  Â  Â  Â  Â  .from("resource_libraries")
Â  Â  Â  Â  Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  Â  Â  Â  Â  .eq("entity_type", entityType)
Â  Â  Â  Â  Â  Â  Â  Â  .eq("entity_id", entityId)
Â  Â  Â  Â  Â  Â  Â  Â  .maybeSingle(); // Use maybeSingle as it might not exist yet
Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  },
Â  Â  Â  Â  enabled: !!entityId,
Â  Â  });
Â  Â  // 2. Fetch Resources if library exists
Â  Â  const { data: resources, isLoading: isResourcesLoading } = useQuery({
Â  Â  Â  Â  queryKey: ["library-resources", library?.id],
Â  Â  Â  Â  queryFn: async () => {
Â  Â  Â  Â  Â  Â  if (!library?.id) return [];
Â  Â  Â  Â  Â  Â  const { data, error } = await supabaseCustom


--- PAGE 107 ---
Â  Â  Â  Â  Â  Â  Â  Â  .from("library_resources")
Â  Â  Â  Â  Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  Â  Â  Â  Â  .eq("library_id", library.id)
Â  Â  Â  Â  Â  Â  Â  Â  .order("created_at", { ascending: false });
Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  },
Â  Â  Â  Â  enabled: !!library?.id,
Â  Â  });
Â  Â  return {
Â  Â  Â  Â  library,
Â  Â  Â  Â  resources: resources || [],
Â  Â  Â  Â  isLoading: isLibraryLoading || isResourcesLoading
Â  Â  };
};]
[
import React, { useState } from 'react';
import { useResourceLibrary, ResourceEntityType } from '@/hooks/useResourceLibrary';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { FileText, Video, Music, Link as LinkIcon, Download, ExternalLink, BookOpen, File,
Loader2 } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from
'@/components/ui/dialog';
interface ResourceListProps {
Â  Â  entityType: ResourceEntityType;
Â  Â  entityId: string;


--- PAGE 108 ---
Â  Â  title?: string;
Â  Â  className?: string;
}
const ResourceList: React.FC = ({ entityType, entityId, title = "Resources", className }) => {
Â  Â  const { resources, isLoading } = useResourceLibrary(entityType, entityId);
Â  Â  const [selectedResource, setSelectedResource] = useState(null);
Â  Â  if (isLoading) {
Â  Â  Â  Â  return
Â  Â  }
Â  Â  if (resources.length === 0) {
Â  Â  Â  Â  return null; // Don't show anything if no resources
Â  Â  }
Â  Â  const getIcon = (type: string) => {
Â  Â  Â  Â  switch (type) {
Â  Â  Â  Â  Â  Â  case 'pdf': return ;
Â  Â  Â  Â  Â  Â  case 'video': return 
Â  Â  Â  Â  Â  Â  case 'audio': return ;
Â  Â  Â  Â  Â  Â  case 'link': return ;
Â  Â  Â  Â  Â  Â  case 'book': return ;
Â  Â  Â  Â  Â  Â  default: return ;
Â  Â  Â  Â  }
Â  Â  };
Â  Â  return (


--- PAGE 109 ---
Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {title}
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  {resources.map((resource) => (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {getIcon(resource.resource_type)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
{resource.title}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {resource.resource_type}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {resource.file_size_mb && â€¢ {resource.file_size_mb} MB}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 


